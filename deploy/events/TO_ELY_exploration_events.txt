namespace = nhs_exploration

### CM1 related events

# Discovery of the shipwrecked nation CM1
country_event = {
	id = nhs_exploration.1
	title = nhs_exploration.1.t
	desc = nhs_exploration.1.d
	picture = western_coast_eventPicture

	goto = 481
	
	fire_only_once = yes
	
	trigger = {
		nhs_condition_all_ely = { KOMANDA = tag }
		exists = CM1
		OR = {
			capital_scope = { has_discovered = CM1 }
			CM1 = { capital_scope = { has_discovered = ROOT } }
		}
	}
	
	mean_time_to_happen = {
		days = 1
	}

	immediate = {
		hidden_effect = {
			discover_province = 481
			discover_province = 1572
			discover_province = 1570
		}
	}
	
	option = {
		name = nhs_exploration.1.a
		# Event: our brethren!
		if = {
			limit = {
				OR = {
					religion = orthodox
					religion = elysian_orthodoxy
				}
			}
			country_event = { id = nhs_exploration.2 days = 10 }
		}
		else_if = {
			limit = {
				religion = pantheon_worship
			}
			country_event = { id = nhs_exploration.3 days = 10 }
		}
		hidden_effect = {
			CM1 = { country_event = { id = nhs_exploration.5 days = 3 } }
		}
		set_country_flag = nhs_discovered_survivors
	}
}

# If Elysia also orthodox: they want to join freely
country_event = {
	id = nhs_exploration.2
	title = nhs_exploration.2.t
	desc = nhs_exploration.2.d
	picture = golden_century_EUROPEAN_REFUGEES_eventPicture

	goto = 481
	
	fire_only_once = yes
	is_triggered_only = yes
	
	trigger = {
		nhs_condition_all_ely = { KOMANDA = tag }
		OR = {
			religion = orthodox
			religion = elysian_orthodoxy
		}
		exists = CM1
		has_country_flag = nhs_discovered_survivors
		NOT = { has_country_flag = nhs_interacted_survivors }
	}

	immediate = {
		set_country_flag = nhs_interacted_survivors
	}
	
	option = { # Welcome them with open arms
		ai_chance = { 
			factor = 90
			# modifier = {
			# 	factor = 0.5
			# 	NOT = { legitimacy = 60 }
			# }
			# modifier = {
			# 	factor = 0
			# 	CM1 = { ai = no }
			# }
		}
		name = nhs_exploration.2.a
		vassalize = CM1
		# create_subject = {
		# 	subject_type = elysian_subject_non_exarch
		# 	subject = CM1
		# }
		# add_legitimacy = -5
		add_adm_power = -50
		hidden_effect = {
			CM1 = {
				set_country_flag = cm1_elysia_made_its_decision
				every_province = {
					limit = {
						has_discovered = ROOT
					}
					discover_country = CM1
				}
			}
		}
	}
	option = { # They'll manage fine on their own
		name = nhs_exploration.2.b
		ai_chance = { 
			factor = 10
			# modifier = {
			# 	factor = 3
			# 	NOT = { legitimacy = 60 }
			# }
		}
		# add_legitimacy = 10
		# Event: left on our own
		CM1 = { country_event = { id = nhs_exploration.6 days = 3 } }
	}
	after = {
		CM1 = {
			set_country_flag = nhs_interacted_survivors
		}
	}
}

# If Elysia pantheon: they need convincing to join
country_event = {
	id = nhs_exploration.3
	title = nhs_exploration.3.t
	desc = nhs_exploration.3.d
	picture = golden_century_EUROPEAN_REFUGEES_eventPicture

	goto = 481
	
	fire_only_once = yes
	is_triggered_only = yes
	
	trigger = {
		nhs_condition_all_ely = { KOMANDA = tag }
		religion = pantheon_worship
		exists = CM1
		has_country_flag = nhs_discovered_survivors
		NOT = { has_country_flag = nhs_interacted_survivors }
	}

	immediate = {
		set_country_flag = nhs_interacted_survivors
	}
	
	option = { # Convince them of the power and glory of our nation and our gods
		name = "nhs_exploration.3.a"
		ai_chance = { 
			factor = 60
			modifier = {
				factor = 0.33
				NOT = { stability = 1 }
			}
		}
		vassalize = CM1
		add_stability = -1
		add_adm_power = -50
		add_dip_power = -50
		# create_subject = {
		# 	subject_type = elysian_subject_non_exarch
		# 	subject = CM1
		# }
		custom_tooltip = nhs_new_line_tt
		CM1 = { 
			change_religion = pantheon_worship
			capital_scope = { change_religion = pantheon_worship }
			hidden_effect = {
				set_country_flag = cm1_elysia_made_its_decision
				every_province = {
					limit = {
						has_discovered = ROOT
					}
					discover_country = CM1
				}
			}
		}
		# add_treasury = -250
		# add_legitimacy = -10	
	}
	option = { # Leave them to their own doing
		name = nhs_exploration.3.b
		ai_chance = {
			factor = 40
			modifier = {
				factor = 2
				NOT = { stability = 1 }
			}
		}
		add_legitimacy = 20
		add_prestige = 10
		custom_tooltip = nhs_new_line_tt
		# Event: left on our own
		CM1 = { country_event = { id = nhs_exploration.6 days = 3 } }
	}
	after = {
		CM1 = {
			set_country_flag = nhs_interacted_survivors
		}
	}
}

# Event to auto-discover CM1 when exploration idea 3 - event 54
country_event = {
	id = nhs_exploration.4
	title = nhs_exploration.4.t
	desc = nhs_exploration.4.d
	picture = western_SHIP_SAILING_eventPicture

	goto = 481
	
	fire_only_once = yes
	
	trigger = {
		nhs_condition_all_ely = { KOMANDA = tag }
		exists = CM1
		OR = {
			has_idea = quest_for_the_new_world
			has_idea = a_new_start
			is_year = 1480
		}
		is_year = 1476
		NOT = { 481 = { has_discovered = ROOT } }
		NOT = { has_country_flag = nhs_discovered_survivors }
	}
	
	mean_time_to_happen = {
		months = 12
		modifier = {
			factor = 0.2
			num_of_explorers = 1
		}
		modifier = {
			factor = 0.25
			1572 = { has_discovered = ROOT }
		}
	}

	immediate = {
		hidden_effect = {
			discover_province = 481
			discover_province = 1572
			discover_province = 1570
		}
	}
	
	option = {
		name = nhs_exploration.4.a
	}
}

# CM1 survivors discovered event
country_event = {
	id = nhs_exploration.5
	title = nhs_exploration.5.t
	desc = nhs_exploration.5.d
	picture = western_coast_eventPicture

	goto = elysian_capital
	
	is_triggered_only = yes

    trigger = {
		tag = CM1
	}

	immediate = {
		hidden_effect = {
			discover_province = 1570
			FROM = {
				capital_scope = {
					save_event_target_as = elysian_capital
					every_province = {
						limit = {
							area = PREV
						}
						discover_country = ROOT
					}
				}
			}
		}
	}

	option = {
		name = nhs_exploration.5.a
		add_stability = 2
		custom_tooltip = nhs_new_line_tt
		custom_tooltip = nhs_settler_heritage_0_2_tt
		custom_tooltip = to_cm1_settler_heritage_two_duration_tt
		hidden_effect = {
			remove_country_modifier = nhs_handicap_settlers
			add_country_modifier = {
				name = nhs_settler_heritage_two
				duration = 18250
			}
		}
		# capital_scope = { add_base_tax = 2 }
		set_country_flag = had_event_nhs_exploration_5
	}
}

# CM1 survivors left on their own
country_event = {
	id = nhs_exploration.6
	title = nhs_exploration.6.t
	desc = nhs_exploration.6.d
	picture = BYZANTINE_EMPEROR_eventPicture
	
	is_triggered_only = yes
	
	trigger = {
		tag = CM1
	}

	immediate = {
		set_country_flag = cm1_elysia_made_its_decision
	}
	
	option = {	
		name = nhs_exploration.6.a
		# if = {
		# 	limit = {
		# 		FROM = {
		# 			OR = {
		# 				religion = orthodox
		# 				religion = elysian_orthodoxy
		# 			}
		# 		}
		# 	}
		# 	add_stability = -1
		# 	add_prestige = -20
		# }
		add_stability = -1
		add_treasury = 100
		# Set flag for free colonies event
		set_country_flag = nhs_hadevent_othersevents53
	}
}

# Events that launch CM1 colonies
country_event = {
	id = nhs_exploration.7
	title = nhs_exploration.7.t
	desc = nhs_exploration.7.d
	picture = caribbean_arrival_eventPicture

	goto = kretan_colony

	fire_only_once = yes
	
	trigger = {
		tag = CM1
		NOT = { has_country_flag = cm1_had_spawned_colonies }
		AND = {
			has_country_flag = cm1_elysia_made_its_decision
			is_subject = no
		}
		# Double check
		NOT = { has_country_flag = cm1_had_spawned_colonies }
	}

	mean_time_to_happen = {
		months = 6
	}
	
	immediate = {
		set_country_flag = cm1_had_spawned_colonies
		hidden_effect = {
			to_nhs_discover_carribean = { TAG = ROOT }
			add_country_modifier = {
				name = nhs_early_uprising_reduction
				duration = 3650
			}
			to_cm1_spawn_carribean_colony = { EVENT_TARGET = kretan_colony }
		}
	}

	option = {
		name = nhs_exploration.7.a
		# add_base_tax = -1
		# add_base_manpower = -2
		if = {
			limit = {
				NOT = { num_of_colonists = 1 }
			}
			add_country_modifier = {
				name = "nhs_new_world"
				duration = -1
			}
		}
		remove_country_modifier = nhs_constrained_resources 
		if = {
			limit = {
				NOT = { has_country_flag = nhs_europe_discovered_got }
			}
			add_country_modifier = {
				name = nhs_constrained_resources_cm1
				duration = -1
			}
		}
		tooltip = {
			add_country_modifier = {
				name = nhs_early_uprising_reduction_tooltip
				duration = 3650
			}
		}
		random_province = {
			limit = {
				region = carribeans_region
				any_neighbor_province = { 
					owned_by = ROOT 
				}
				is_empty = yes
			}
			custom_tooltip = cm1_colonise_tt
			hidden_effect = {
				save_event_target_as = second_kretan_colony
			}
			change_culture = ROOT
			change_religion = ROOT
		}
		hidden_effect = {
			if = {
				limit = {
					has_saved_event_target = second_kretan_colony
				}
				capital_scope = {
					event_target:second_kretan_colony = {
						create_colony = 400
						province_recalculate_estate_privileges_effect_natives = yes
					}
				}
			}
		}
	}
}

country_event = {
	id = nhs_exploration.8
	title = nhs_exploration.8.t
	desc = nhs_exploration.8.d
	picture = caribbean_arrival_eventPicture

	goto = kretan_colony

	fire_only_once = yes
	is_triggered_only = yes
	
	trigger = {
		tag = CM1
		# Double check
		NOT = { has_country_flag = cm1_had_spawned_colonies }
	}
	
	immediate = {
		set_country_flag = cm1_had_spawned_colonies
	}

	option = {
		name = nhs_exploration.8.a
		if = {
			limit = {
				NOT = { num_of_colonists = 1 }
			}
			add_country_modifier = {
				name = "nhs_new_world"
				duration = -1
			}
		}
		remove_country_modifier = nhs_constrained_resources
		if = {
			limit = {
				NOT = { has_country_flag = nhs_europe_discovered_got }
			}
			add_country_modifier = {
				name = nhs_constrained_resources_cm1
				duration = -1
			}
		}
		tooltip = {
			add_country_modifier = {
				name = nhs_early_uprising_reduction_tooltip
				duration = 3650
			}
		}
		random_province = {
			limit = {
				region = carribeans_region
				any_neighbor_province = { 
					owned_by = ROOT 
				}
				is_empty = yes
			}
			custom_tooltip = cm1_colonise_tt
			hidden_effect = {
				save_event_target_as = second_kretan_colony
			}
			change_culture = ROOT
			change_religion = ROOT
		}
		hidden_effect = {
			if = {
				limit = {
					has_saved_event_target = second_kretan_colony
				}
				capital_scope = {
					event_target:second_kretan_colony = {
						create_colony = 400
						province_recalculate_estate_privileges_effect_natives = yes
					}
				}
			}
		}
	}
}