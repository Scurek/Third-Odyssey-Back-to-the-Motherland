namespace = nhs_all_natives_estates


# -- Change natives estate (early-mid-late) --

# Remove flags from non-exile nations and spartans
country_event = {
    id = nhs_all_natives_estates.1
	title = nhs2_hidden.t
	desc = nhs2_hidden.d
	picture = COURT_eventPicture

    hidden = yes

	trigger = {
        OR = {
		    NOT = { nhs_check_all_exiles = { CONDITION = tag } }
            nhs_check_all_spartan = { CONDITION = tag }
        }
        OR = {
            has_country_flag = native_council_enabled_early
            has_country_flag = native_council_enabled_mid
            # has_country_flag = native_council_enabled_late
        }
	}

    immediate = {
		clr_country_flag = native_council_enabled_early
		clr_country_flag = native_council_enabled_mid
		# clr_country_flag = native_council_enabled_late
    }

	option = {	
		name = "Should not be visible!"
		ai_chance = { factor = 100 }
	}

}

# Sets an appropriate native council estate flag and triggers an informative event with one day delay (have to do this because game only recalculates existing estates at the start of each day
country_event = {
    id = nhs_all_natives_estates.2
	title = nhs2_hidden.t
	desc = nhs2_hidden.d
	picture = COURT_eventPicture

    hidden = yes

	trigger = {
        NOT = {
            OR = {
                has_country_flag = native_council_enabled_early
                has_country_flag = native_council_enabled_mid
                # has_country_flag = native_council_enabled_late
            }
        }
		nhs_check_all_exiles = { CONDITION = tag }
        NOT = { nhs_check_all_spartan = { CONDITION = tag } }
        OR = {
            AND = {
                NOT = { nhs_check_all_vinland = { CONDITION = tag } }
                NOT = { is_subject_of_type = elysian_subject_varangian }
		        num_of_cities = 5
            }
            AND = {
                nhs_check_all_vinland = { CONDITION = tag }
                num_of_cities = 3
                OR = {
                    had_global_flag = { flag = nhs_visitors days = 90 }
                    # Fallback, just in case
                    is_year = 1455
                }
            }
        }
	}

    immediate = {
		hidden_effect = {
			nhs_add_appropriate_native_estate_flag = yes
            if = {
                limit = {
                    any_country = {
                        exists = yes
                        ai = yes
                    }
                }
                if = {
                    limit = {
                        nhs_check_all_vinland = { CONDITION = tag }
                    }
                    country_event = {
                        id = natives_estate_events.101
                        days = 1
                    }
                }
                else = {
                    country_event = {
                        id = natives_estate_events.100
                        days = 1
                    }
                }
                # Stupid problems require stupid solutions. Since setting crown land in immediate one day later doesn't work, we trigger the event for random ai that has this effect in option. For some reason this works.
                set_country_flag = nhs_set_initial_councils_stats
                random_country = {
                    limit = {
                        ai = yes
                    }
                    country_event = {
                        id = nhs_all_natives_estates.3
                        days = 1
                    }
                }
            }
            else = {
                if = {
                    limit = {
                        nhs_check_all_vinland = { CONDITION = tag }
                    }
                    country_event = {
                        id = natives_estate_events.101
                        days = 2
                    }
                }
                else = {
                    country_event = {
                        id = natives_estate_events.100
                        days = 2
                    }
                }
            }
		}
    }

	option = {	
		name = "Should not be visible!"
		ai_chance = { factor = 100 }
	}
}

# Stupid problems require stupid solutions. Since setting crown land in immediate one day later doesn't work, we trigger the event for random ai that has this effect in option. For some reason this works.
country_event = {
    id = nhs_all_natives_estates.3
	title = nhs2_hidden.t
	desc = nhs2_hidden.d
	picture = COURT_eventPicture

    hidden = yes
    is_triggered_only = yes

    immediate = {
    }

	option = {	
		name = "Should not be visible!"
		ai_chance = { factor = 100 }
        every_country = {
            limit = {
                has_country_flag = nhs_set_initial_councils_stats
            }
            clr_country_flag = nhs_set_initial_councils_stats
            change_estate_land_share = {
                estate = estate_all_natives
                share = -100
            }
            add_estate_loyalty = {
                estate = estate_all_natives
                loyalty = -100
            }
            if = {
                limit = {
                    has_country_flag = native_council_enabled_early
                }
                add_estate_loyalty = {
                    estate = estate_all_natives
                    loyalty = 15
                }
            }
            else = {
                add_estate_loyalty = {
                    estate = estate_all_natives
                    loyalty = 20
                }
            }
        }
	}
}

# Set mid flag (except spartans who get none, always for norse, after colonialism for other exiles)
# country_event = {
#     id = nhs_all_natives_estates.3
# 	title = nhs_all_natives_estates.3.t
# 	desc = nhs_all_natives_estates.3.d
# 	picture = COURT_eventPicture

#     hidden = yes

# 	trigger = {
#         has_country_flag = native_council_enabled_early
#         NOT = { has_country_flag = native_council_enabled_mid }
#         NOT = { has_country_flag = native_council_enabled_late }
#         has_institution = new_world_i
#         nhs_check_all_exiles = { CONDITION = tag }
# 		NOT = { nhs_check_all_vinland = { CONDITION = tag } }
# 		NOT = { nhs_check_all_spartan = { CONDITION = tag } }
# 		NOT = { is_subject_of_type = elysian_subject_varangian }
# 	}

#     immediate = {
# 		clr_country_flag = native_council_enabled_early
# 		set_country_flag = native_council_enabled_mid
# 		clr_country_flag = native_council_enabled_late
#     }

# 	option = {	
# 		name = "Should not be visible!"
# 		ai_chance = { factor = 100 }
# 	}
# }

# # Set late flag (after global trade for all exiles, except for spartans who get none)
# country_event = {
#     id = nhs_all_natives_estates.4
# 	title = nhs_all_natives_estates.4.t
# 	desc = nhs_all_natives_estates.4.d
# 	picture = COURT_eventPicture

#     hidden = yes

# 	trigger = {
#         OR = {
#             has_country_flag = native_council_enabled_early
#             has_country_flag = native_council_enabled_mid
#         }
#         NOT = { has_country_flag = native_council_enabled_late }
#         nhs_check_all_exiles = { CONDITION = tag }
#         has_institution = global_trade
#         NOT = { nhs_check_all_spartan = { CONDITION = tag } } 
# 	}

#     immediate = {
# 		clr_country_flag = native_council_enabled_early
# 		clr_country_flag = native_council_enabled_mid
# 		set_country_flag = native_council_enabled_late
#     }

# 	option = {	
# 		name = "Should not be visible!"
# 		ai_chance = { factor = 100 }
# 	}

# }