# country
nhs_on_startup = {
	if = {
		limit = {
			NOT = { has_global_flag = to_setup_done }
		}
		nhs_set_up_empty_province_flags = yes
		vov_setup_coastal_bonus = yes
		to_remove_tribal_land = yes
		to_nat_set_development = yes
		to_nat_tribal_development_setup = yes
		to_nat_migratory_development_setup = yes
		to_set_up_nodlc_coal = yes
		every_country = {
			to_non_abrahamic_conversion_penalty_check_country = yes
		}
		every_province = {
			limit = {
				OR = {
					is_empty = yes
					is_colony = yes
				}
			}
			to_check_native_size = yes
		}
		1501 = {
			add_province_triggered_modifier = to_yearly_event_pulse
			add_province_triggered_modifier = to_monthly_event_pulse
		}
		to_dynamic_cot_setup = yes
		set_global_flag = to_setup_done
	}
	# Ensuring compatibility, remove later
	to_ongoing_fixes = yes
}

to_set_up_nodlc_coal = {
	if = {
		limit = {
			NOT = { has_dlc = "Rule Britannia" }
		}
		every_province = {
			limit = {
				nhs_has_coal = yes
				NOT = { has_province_modifier = nhs2_lantent_coal_tm }
			}
			add_permanent_province_modifier = {
				name = nhs2_lantent_coal
				duration = -1
			}
			add_province_triggered_modifier = nhs2_lantent_coal_tm
		}
	}
}

nhs_set_up_empty_province_flags = {
	every_province = {
		if = {
			limit = {
				is_empty = yes
			}
			set_province_flag = nhs_is_empty_province
		}
		else_if = {
			limit = {
				has_province_flag = nhs_is_empty_province
			}
			clr_province_flag = nhs_is_empty_province
		}
	}
}

to_yearly_event_pulse_effect = {
	to_trigger_hellenic_festival_tombola = yes
}

to_two_year_event_pulse_1_effect = {
	if = {
		limit = {
			NOT = { is_year = 1468 }
			nhs_check_existing_elysian_tags_with_full_condition = {
				CONDITION = "has_country_flag = hellenic_conversion_preacher"
			}
		}
		nhs_effect_for_existing_elysian_tag = {
			EFFECT = "
				country_event = { 
					id = nhs_hellenicconversion.100
					days = 120
					random = 120
				}
			"
		}
	}
}

to_two_year_event_pulse_2_effect = {
}

to_three_year_event_pulse_1_effect = {
	if = {
		limit = {
			NOT = { is_year = 1468 }
			nhs_check_existing_elysian_tags_with_full_condition = {
				CONDITION = "has_country_flag = nhs_pagan_assemblies"
			}
		}
		random_list = {
			50 = {
				nhs_effect_for_existing_elysian_tag = {
					EFFECT = "
						country_event = { 
							id = nhs_hellenicconversion.1000
							days = 1
							random = 120
						}
					"
				}
			}
			50 = {
				nhs_effect_for_existing_elysian_tag = {
					EFFECT = "
						country_event = { 
							id = nhs_hellenicconversion.1000
							days = 240
							random = 120
						}
					"
				}
			}
		}
	}
}

to_three_year_event_pulse_2_effect = {
	if = {
		limit = {
			NOT = { is_year = 1468 }
			nhs_check_existing_elysian_tags_with_full_condition = {
				CONDITION = "to_nhs_hellenic_disaster_eligible_for_inquisition_events = yes"
			}
		}
		random_list = {
			50 = {
				nhs_effect_for_existing_elysian_tag = {
					EFFECT = "
						country_event = { 
							id = nhs_hellenicconversion.1001
							days = 1
							random = 120
						}
					"
				}
			}
			50 = {
				nhs_effect_for_existing_elysian_tag = {
					EFFECT = "
						country_event = { 
							id = nhs_hellenicconversion.1001
							days = 240
							random = 120
						}
					"
				}
			}
		}
	}
}

to_three_year_event_pulse_3_effect = {
}

to_monthly_pulse_effect = {
	to_culture_adaptation_progress_routine = yes
	to_elysian_highways_progress_routine = yes
}

nhs_handle_colonies = {
	if = {
		limit = {
			has_province_flag = nhs_is_empty_province
			is_empty = no
			owner = {
				has_native_government = yes
				NOT = { has_reform = native_settle_down_reform }
				NOT = { num_of_cities = 2 }
			}
			# OR = {
			# 	is_capital = yes
			# 	owner = {
			# 		can_migrate = yes
			# 		NOT = { num_of_cities = 2 }
			# 	}
			# }
		}
		# HANDLE NATIVE MIGRATION
		clr_province_flag = nhs_is_empty_province
		clr_province_flag = nhs_is_colony
		to_nat_on_migrate_province = yes
	}
	else_if = {
		limit = {
			has_province_flag = nhs_is_empty_province
			is_empty = no
			# is_colony = yes
		}
		on_colony_created = yes
		clr_province_flag = nhs_is_empty_province
		set_province_flag = nhs_is_colony
	}
	else_if = {
		limit = {
			NOT = { has_province_flag = nhs_is_empty_province }
			is_empty = yes
		}
		on_colony_destroyed = yes
		set_province_flag = nhs_is_empty_province
		clr_province_flag = nhs_is_colony
		change_tribal_land = ---
		to_check_native_size = yes
		to_nat_remove_local_migratory_development = yes
		to_nat_restore_local_tribal_development = yes
	}
}

on_colony_created = {
	vov_handle_culture_change_on_coastal_bonus = yes
	nhs_settler_boost_on_colony_created = yes
	handle_nhs_native_priv_inclusive_citizenship_modifier = yes
	handle_to_vov_native_priv_benevolent_conquerors_modifier = yes
	to_nat_handle_colonise_own_culture_modifier = yes
	to_nat_handle_colonise_foreign_culture_modifier = yes
	to_nat_handle_native_expansion_modifier = yes
	to_nat_handle_expand_overseas_modifier = yes

	to_destroy_forbidden_colonies = yes
}

on_colony_destroyed = {
	remove_province_modifier = nhs_native_priv_inclusive_citizenship_mod
}

on_colony_finished = {
	# to_nat_add_temporary_depopulation = yes
	# to_ely_province_culture_check = {}
	handle_nhs_native_priv_ancestral_land_colony_finished = yes
	to_nat_tribal_displacement_obtain_local_plunder = { PROVINCE_SCOPE = ROOT COUNTRY_SCOPE = owner }
	to_nat_remove_tribal_development = yes
	to_nat_handle_colonise_own_culture_modifier = yes
	to_nat_handle_colonise_foreign_culture_modifier = yes
	to_nat_handle_native_expansion_modifier = yes
	to_nat_handle_expand_overseas_modifier = yes
	handle_nhs_native_priv_inclusive_citizenship_colony_finished = yes
	handle_to_vov_native_priv_benevolent_conquerors_colony_finished = yes
	handle_to_nhs_estate_nhs_nobles_land_sale_privilege_colony_finished = yes
	to_varangian_expedition_on_colony_finished = yes
	vov_handle_culture_change_on_coastal_bonus = yes

	to_nhs_handle_capital_area_cores_colonisation = yes

	to_nhs_handle_post_disaster_tolerance_modifier = yes
	to_nhs_handle_lots_of_people_modifiers = yes
	nhs_handle_naphtha = yes
	# to_ely_province_culture_add_autonomy = yes
	province_event = { id = to_nat_tribal_development.1 }
	clr_province_flag = to_static_colonial_culture
}

# province
# FROM = old owner
nhs_on_province_owner_change = {
	to_nat_on_conquered_migratory_development = yes
	nhs_handle_colonies = yes
	vov_handle_grand_forestries = yes
	msg_handle_slaves = yes
	nhs_handle_fort_manpower = yes
	to_nhs_handle_capital_area_cores_conquest = yes
	# nhs_assign_names_effect = yes
	vov_handle_coastal_bonus = yes
	vov_handle_brave_the_elements = yes
	province_recalculate_estate_privileges_effect_natives = yes
	handle_to_vov_native_priv_freedom_of_worship_modifier = yes
	to_nat_handle_colonise_own_culture_modifier = yes
	to_nat_handle_colonise_foreign_culture_modifier = yes
	to_nat_handle_native_expansion_modifier = yes
	to_nat_handle_expand_overseas_modifier = yes
	to_nat_handle_grand_confederation_modifier = yes
	to_handle_greek_immigration_modifier = yes
	to_nat_remove_tribal_development = yes
	to_culture_adaptation_on_owner_change = yes
	to_culture_integrated_on_owner_change = yes
	nhs_handle_naphtha = yes
	nhs_handle_supply_lines = yes
	nhs_handle_base_of_operations = yes
	to_nhs_handle_exemption_from_hellenic_disaster = yes
	to_nhs_handle_post_disaster_tolerance_modifier = yes
	to_nhs_handle_inwards_path_province_modifiers = yes
	to_assemble_an_invasion_force_mission_handle_modifiers = yes
	to_handle_new_patriarch_modifier = yes
	to_handle_traditional_patriarch_modifier = yes
	to_check_exarch_claims_on_province_gained = yes
	to_check_exarch_claims_on_province_lost = yes
	to_triumph_province_counter_check = yes
	to_handle_elysian_penal_colony_modifier = yes
	to_japanese_boost_check = yes
	to_handle_para_bellum_modifier = yes
	to_non_abrahamic_conversion_penalty_check_province = yes
	to_check_missionary_strength_from_battles = yes
	to_handle_familiar_administration_modifier = yes
	to_cultureshock_on_province_owner_culture_change = yes
	to_check_separatism_in_turkish_provinces = yes
	to_check_separatism_in_christian_roman_and_sunni_levantine_provinces = yes
	to_check_dynatoi_garrisons = yes
	to_check_greek_religion_approach = {}
	to_add_ia_upon_conquest = yes
	
	if = {
		limit = {
			nhs_homelands_building_counter_trigger = yes
			owner = {
				nhs_check_all_elysian_tags = { CONDITION = tag }
			}
		}
		nhs_homelands_building_counter_eval_local_province = yes
	}
	else_if = {
		limit = {
			nhs_homelands_building_counter_trigger = yes
			FROM = {
				nhs_check_all_elysian_tags = { CONDITION = tag }
			}
		}
		nhs_homelands_building_counter_eval_former_province = yes
	}

	if = {
		limit = {
			continent = north_america
			owner = {
				nhs_check_all_elysian_tags = { CONDITION = tag }
			}
		}
		nhs_hightier_building_counter_eval_local_province = yes
	}
	else_if = {
		limit = {
			continent = north_america
			FROM = {
				nhs_check_all_elysian_tags = { CONDITION = tag }
			}
		}
		nhs_hightier_building_counter_eval_former_province = yes
	}

	clr_province_flag = to_check_culture_after_conversion
}

# province:  spawned whenever a new owner takes over the province
# FROM = The previous owner.
to_on_conquest = {
}

# ROOT = Overlord, FROM = Minor
nhs_on_dependency_gained = {
	FROM = {
		if = {
			limit = {
				has_country_modifier = msg_rise_of_sparta
			}
			remove_country_modifier = msg_rise_of_sparta
		}
		else_if = {
			limit = {
				has_country_modifier = msg_rise_of_sparta_2
			}
			remove_country_modifier = msg_rise_of_sparta_2
		}
		else_if = {
			limit = {
				has_country_modifier = msg_rise_of_sparta_3
			}
			remove_country_modifier = msg_rise_of_sparta_3
		}
		to_nat_determine_new_confederation_leader = yes
		to_check_exarch_claims_on_become_subject = yes
		to_correct_colony_culture = yes
		to_triumph_province_counter_dependancy_gained = { SCOPE = ROOT }
		to_handle_subject_annexation_date = yes
		
		to_inherit_overlords_councils_privileges = yes
		to_non_abrahamic_conversion_penalty_check_country = yes
		to_handle_greek_immigration_modifier_country = yes
		to_handle_familiar_administration_modifier_country = yes
	}
	to_nhs_handle_inwards_path_province_modifiers_all_provinces = yes
	nhs_handle_naphtha_in_subject = yes
}

# ROOT = Overlord, FROM = Minor
nhs_on_dependency_lost = {
	nhs_handle_naphtha_in_subject = yes
	FROM = {
		clr_country_flag = to_subsidising_colonisation
		to_triumph_province_counter_dependancy_lost = { SCOPE = ROOT }
		to_non_abrahamic_conversion_penalty_check_country = yes
		to_handle_greek_immigration_modifier_country = yes
		to_handle_familiar_administration_modifier_country = yes
	}
}

# province
nhs_on_province_culture_converted = {
	# nhs_assign_names_effect = yes
	# to_ely_province_culture_check = {}
	to_check_culture_after_conversion = yes
	to_nat_tribal_development_on_province_culture_converted = yes
	nhs_on_province_culture_converted_general = {}
	if = {
		limit = {
			has_province_modifier = msg_slave_province_tm
		}
		remove_province_triggered_modifier = msg_slave_province_tm
	}
	if = {
		limit = {
			has_province_modifier = msg_liberated_slaves
		}
		remove_province_modifier = msg_liberated_slaves
	}
}

nhs_on_province_culture_converted_general = {
	[[CHECK_ELY_CULTURE]
	if = {
		limit = {
			owner = {
				nhs_post_fragmentation_culturally_elysian = yes
			}
		}
		to_ely_province_culture_check = {}
	}
	]
	province_recalculate_estate_privileges_effect_natives = yes
	to_nat_handle_grand_confederation_modifier = yes
	handle_to_vov_native_priv_freedom_of_worship_modifier = yes
	to_nhs_handle_post_disaster_tolerance_modifier = yes
	to_handle_new_patriarch_modifier = yes
	to_handle_traditional_patriarch_modifier = yes
	to_culture_adaptation_on_culture_change = yes
	to_culture_integrated_on_culture_change = yes

	to_handle_greek_immigration_modifier = yes
	to_handle_familiar_administration_modifier = yes
	to_cultureshock_on_province_owner_culture_change = yes

	to_handle_symmachoi_flags_on_culture_conversion = yes
	to_handle_skraeling_flags_on_culture_conversion = yes
}

# country
nhs_on_religion_change = {
	if = {
		limit = {
			has_reform = spartan_kingdom
		}
		if = {
			limit = {
				OR = {
					religion = orthodox
					religion = elysian_orthodoxy
				}
			}
			add_government_reform = msg_christian0_ref
			add_government_reform = msg_spartan_patriarch_no
			add_government_reform = msg_holy_army_no
			add_government_reform = msg_saint_leo_no
		}
		else_if = {
			limit = {
				religion = pantheon_worship
			}
			add_government_reform = msg_hellenic0_ref
			add_government_reform = msg_spartan_heralds_no
			add_government_reform = msg_native_deities_no
			add_government_reform = msg_deify_leonidas_no
		}
		else_if = {
			limit = {
				religion = aztlan_worship
			}
			add_government_reform = msg_aztlan0_ref
			add_government_reform = msg_aztlan_priesthood_no
			add_government_reform = msg_old_faith_no
			add_government_reform = msg_sacrifice_no
		}
	}
	to_nhs_handle_post_disaster_tolerance_modifier_all_provinces = yes
	to_add_new_patriarch_modifier_all_provinces = yes
	to_add_traditional_patriarch_modifier_all_provinces = yes
	to_non_abrahamic_conversion_penalty_check_country = yes

	to_clear_all_defender_of_faith_mission_flags = yes
	to_refresh_elysian_missions = yes
	to_remove_missionary_strength_from_battles_from_owned_provinces = yes
	to_check_greek_religion_approach_on_owner_religion_change = yes
}

# country
# root = winning country, from = loser country
to_on_battle_won_country = {
	if = {
		limit = {
			FROM = { 
				tag = NAT
			}
		}
		ROOT = { set_country_flag = to_natives_won_battle }
	}
	if = {
		limit = {
			tag = NAT
		}
		FROM = { set_country_flag = to_natives_won_battle }
	}
}

# province
# root = location, from = loser country
to_on_battle_won_province = {
	to_nat_check_for_tribal_displacement_on_attack_natives = yes
}

# province
# root = location, from = winner country
to_on_battle_lost_province = {
	to_nat_check_for_tribal_displacement_on_attack_natives = yes
}

#Unit Scope OnAction for Battle Won
to_on_battle_won_unit = {
	to_add_missionary_strength_from_battles = yes
}

# country
# root = winning country, from = loser country
to_on_war_won = {
	ROOT = {
		if = {
			limit = {
				is_at_war = no
			}
			clr_country_flag = to_declined_war_chief
		}
		add_faction_influence = {
			faction = vin_vikingr
			influence = 5
		}
		country_event = { id = nhs_vov_coloniesevents.50 }
		country_event = { id = nhs2_mainlandevents.24 }
		country_event = { id = nhs2_mainlandevents.13 }
		country_event = { id = nhs2_mainlandevents.19 days = 3 }
		# country_event = { id = elysian_revolution.102 }
	}
	FROM = {
		if = {
			limit = {
				is_at_war = no
			}
			clr_country_flag = to_declined_war_chief
		}
		to_nat_handle_envoy_to_the_world = yes
	}

	to_missionary_strength_from_battles_after_war = {
		CHECK_IF = "always = yes"
		CHECK_FROM = yes 
	}

	clr_country_flag = to_gives_defender_of_faith_credit
	clr_country_flag = to_gives_defender_of_faith_great_power_credit
	clr_country_flag = to_gives_defender_of_faith_minor_credit
}

on_main_war_won = {
	to_increase_defender_of_faith_mission_progress_dof = yes
}

# country
# root = winning country, from = loser country
to_on_separate_war_won = {
	to_clear_invalid_defender_of_faith_mission_flags = yes
}

# country
# root = loser country, from = winner country
to_on_war_lost = {
	to_increase_defender_of_faith_progress = { 
		EFFECT_SCOPE = every_country 
		TARGET = FROM 
	}
}

to_on_country_creation = {
	to_nat_handle_envoy_to_the_world = yes
	if = {
		limit = {
			nhs_check_all_elysian_tags = { CONDITION = tag }
		}
		to_upgrade_japanese_boosts = yes
	}
}

# Nation annexed.
# FROM is the nation being annexed
to_on_annexed = {
	FROM = {
		to_nat_determine_new_confederation_leader = yes
		to_nhs_remove_exarch_cores = yes
		to_downgrade_japanese_boosts = yes

		to_increase_defender_of_faith_progress = { 
			EFFECT_SCOPE = if 
			TARGET = ROOT
		}
	}
}

# FROM is the nation being annexed
to_on_diplomatic_annex = {
	to_check_opinion_annex_limit = yes
}

# FROM is the nation being annexed
to_on_integrate = {
	to_check_opinion_annex_limit = yes
}

#ROOT = converted country, FROM = country which force converts ROOT, on_action gets called on Force religion peace and Enforce Religion subject interaction
to_on_force_conversion = {
	to_defender_of_faith_mission_check_force_conversion = yes
}

# country
to_on_death_election = {
	if = {
		limit = {
			has_reform = varangian_guard
			has_country_flag = vov_varangian_has_heir
		}
		clr_country_flag = vov_varangian_has_heir
	}
	else = {
		country_event = { id = nhs_vov_varangian_order_events.202 }
		country_event = { id = oth_ctm_events.2 }
	}
	if = {
		limit = {
			has_reform = cretan_admiralty
			has_country_flag = vov_varangian_has_heir
		}
		clr_country_flag = vov_varangian_has_heir
	}
	else = {
		country_event = { id = oth_ctm_events.2 }
	}
}

nhs_on_culture_promoted = {
	handle_nhs_native_priv_cultural_sufferance_modifier = yes
}

nhs_on_culture_demoted = {
	handle_nhs_native_priv_cultural_sufferance_modifier = yes
}

nhs_on_primary_culture_changed = {
	handle_nhs_native_priv_cultural_sufferance_modifier = yes
	vov_handle_coastal_bonus_all_owned_provinces = yes
	to_nhs_handle_post_disaster_tolerance_modifier_all_provinces = yes
	to_add_new_patriarch_modifier_all_provinces = yes
	to_add_traditional_patriarch_modifier_all_provinces = yes

	to_nat_handle_colonise_own_culture_modifier_on_culture_change = yes
	to_japanese_boost_check_owned_provinces = yes
	to_cultureshock_on_primary_culture_change = yes
}

to_on_province_religion_converted = {
	handle_to_vov_native_priv_freedom_of_worship_modifier = yes
	to_nhs_handle_post_disaster_tolerance_modifier = yes
	to_handle_new_patriarch_modifier = yes
	to_handle_traditional_patriarch_modifier = yes
	to_japanese_boost_check = yes
	to_non_abrahamic_conversion_penalty_check_province = yes
	to_check_greek_religion_approach = { REMOVE_OTHERWISE = yes }
}

to_on_country_released = {
	if = {
		limit = {
			tag = SHQ
			FROM = { 
				nhs_check_all_elysian_tags = { CONDITION = tag }
				NOT = { is_year = 1550 }
				NOT = { has_country_flag = nhs_three_lands }
			}
		}
		to_remove_all_idea_groups = yes
	}
}


to_on_defender_of_faith_claim = {
	if = {
		limit = {
			religion = catholic
		}
		set_global_flag = to_saved_catholic_dof_et
		save_global_event_target_as = to_catholic_dof
	}
	else_if = {
		limit = {
			religion = orthodox
		}
		set_global_flag = to_saved_orthodox_dof_et
		save_global_event_target_as = to_orthodox_dof
	}

	to_add_champion_of_faith_modifier = yes
}

to_on_defender_of_faith_loss = {
	to_clear_RELIGION_defender_of_faith_et = { RELIGION = catholic }
	to_clear_RELIGION_defender_of_faith_et = { RELIGION = orthodox }
	to_remove_champion_of_faith_modifier = yes
}

# province
to_on_capital_moved = {
	to_handle_varangian_quarter_on_capital_moved = yes
	to_handle_epilektoi_garrison_on_capital_moved = yes
}