### UNIVERSAL INTEGRATION SYSTEM

to_culture_adaptation_on_culture_change = {
	if = {
		limit = {
			NOT = {
				is_variable_equal = {
					which = to_assimilation_progress
					value = 0
				}
			}
		}
		if = {
			limit = {
				to_has_greek_integration = yes
			}
			set_variable = {
				which = to_assimilation_progress
				value = 50
			}
			set_variable = {
				which = to_assimilation_progress_display
				value = 50
			}
			set_province_flag = to_assimilation_active
		}
		else_if = {
			limit = {
				OR = {
					NOT = { nhs_culturally_native = yes }
					culture = elysameric
					culture = skraeling
				}
			}
			to_remove_culture_adaptation_variables = yes
		}
	}
}

to_culture_adaptation_on_owner_change = {
	if = {
		limit = {
			NOT = { has_province_flag = nhs_is_empty_province }
			NOT = { has_province_flag = nhs_is_colony }
			to_has_culture_adaptation_potential = yes
		}
		if = {
			limit = {
				NOT = { owner = { culture_group = FROM } }
			}
			to_remove_culture_adaptation_variables = yes
		}
		else = {
			to_start_culture_adaptation = yes
		}
	}
}

to_culture_integrated_on_culture_change = {
	if = {
		limit = {
			to_has_culture_integrated = yes
		}
		clr_province_flag = to_culture_integrated_flag
		to_remove_culture_integration_modifiers = yes
	}
}

to_culture_integrated_on_owner_change = {
	if = {
		limit = {
			to_has_culture_integrated = yes
			owner = {
				to_enabled_european_culture_integration = yes
			}
		}
		to_add_appropriate_culture_integration_modifier = yes
	}
}

to_imperial_integration_country_check = {
	if = {
		limit = {
			to_enabled_european_culture_integration = yes
		}
		every_owned_province = {
			limit = {
				to_has_culture_integrated = yes
			}
			to_remove_culture_integration_modifiers = yes
			to_add_appropriate_culture_integration_modifier = yes
		}
	}
}

to_imperial_integration_on_primary_culture_changed = {
	if = {
		limit = {
			NOT = { to_has_exarch_government_reform = yes }
		}
		to_imperial_integration_country_check = yes
	}
}

to_imperial_integration_on_culture_promoted_demoted = {
	if = {
		limit = {
			NOT = { to_has_exarch_government_reform = yes }
		}
		to_imperial_integration_country_check = yes
	}
}

to_start_culture_adaptation = {
	if = {
		limit = {
			to_has_culture_adaptation_potential = yes
		}
		owner = {
			save_event_target_as = to_culture_assimilation_owner
		}
		to_generic_adaptation_types_effect = {
			EFFECT = "
			set_province_flag = to_assimilation_active
			set_province_flag = to_block_culture_integration_completion
			if = {
				limit = {
					is_variable_equal = {
						which = to_assimilation_progress
						value = 0
					}
				}
				set_variable = {
					which = to_assimilation_progress
					value = 0
				}
			}
			set_variable = {
				which = to_assimilation_progress_stored
				which = to_assimilation_progress
			}
			"
			ASSIMIATION_EFFECT_INCREASING = "
			to_increase_culture_adaptation_progress_general = { 
				OWNER_TARGET = to_culture_assimilation_owner
				SPECIFIC_PROGRESS_INCREASE = to_culture_assimilation_progress
			}"
			GREEK_INTEGRATION_EFFECT_INCREASING = "
			to_increase_culture_adaptation_progress_general = { 
				OWNER_TARGET = to_culture_assimilation_owner
				SPECIFIC_PROGRESS_INCREASE = to_greek_integration_progress
			}"
			EUROPEAN_INTEGRATION_EFFECT_INCREASING = "
			to_increase_culture_adaptation_progress_general = { 
				OWNER_TARGET = to_culture_assimilation_owner
				SPECIFIC_PROGRESS_INCREASE = to_culture_integration_progress
			}"
			TRIBAL_INTEGRATION_EFFECT_INCREASING = "
			to_increase_culture_adaptation_progress_general = { 
				OWNER_TARGET = to_culture_assimilation_owner
				SPECIFIC_PROGRESS_INCREASE = to_tribal_integration_progress
			}"
			EFFECT_NOT_INCREASING = "to_culture_adaptation_inactive_setup = yes"
			EFFECT_AFTER = "
			set_variable = {
				which = to_assimilation_progress
				which = to_assimilation_progress_stored
			}
			set_variable = {
				which = to_assimilation_progress_display
				which = to_assimilation_progress
			}
			to_round_down_variable_one_decimal = { VARIABLE = to_assimilation_progress_display }
			clr_province_flag = to_block_culture_integration_completion
			"
		}
	}
}

to_generic_adaptation_types_effect = {
	if = {
		limit = {
			to_has_culture_assimilation = yes
		}
		[[EFFECT]$EFFECT$]
		[[ASSIMIATION_EFFECT]$ASSIMIATION_EFFECT$]
		if = {
			limit = {
				to_culture_assimilation_increasing = yes
			}
			[[EFFECT_INCREASING]$EFFECT_INCREASING$]
			[[ASSIMIATION_EFFECT_INCREASING]$ASSIMIATION_EFFECT_INCREASING$]
		}
		else = {
			[[EFFECT_NOT_INCREASING]$EFFECT_NOT_INCREASING$]
			[[ASSIMIATION_EFFECT_NOT_INCREASING]$ASSIMIATION_EFFECT_NOT_INCREASING$]
		}
		[[EFFECT_AFTER]$EFFECT_AFTER$]
	}
	else_if = {
		limit = {
			to_has_greek_integration = yes
		}
		[[EFFECT]$EFFECT$]
		[[GREEK_INTEGRATION_EFFECT]$GREEK_INTEGRATION_EFFECT$]
		if = {
			limit = {
				to_greek_integration_increasing = yes
			}
			[[EFFECT_INCREASING]$EFFECT_INCREASING$]
			[[GREEK_INTEGRATION_EFFECT_INCREASING]$GREEK_INTEGRATION_EFFECT_INCREASING$]
		}
		else = {
			[[EFFECT_NOT_INCREASING]$EFFECT_NOT_INCREASING$]
			[[GREEK_INTEGRATION_EFFECT_NOT_INCREASING]$GREEK_INTEGRATION_EFFECT_NOT_INCREASING$]
		}
		[[EFFECT_AFTER]$EFFECT_AFTER$]
	}
	else_if = {
		limit = {
			to_has_european_culture_integration = yes
		}
		[[EFFECT]$EFFECT$]
		[[EUROPEAN_INTEGRATION_EFFECT]$EUROPEAN_INTEGRATION_EFFECT$]
		if = {
			limit = {
				to_culture_integration_increasing = yes
			}
			[[EFFECT_INCREASING]$EFFECT_INCREASING$]
			[[EUROPEAN_INTEGRATION_EFFECT_INCREASING]$EUROPEAN_INTEGRATION_EFFECT_INCREASING$]
		}
		else = {
			[[EFFECT_NOT_INCREASING]$EFFECT_NOT_INCREASING$]
			[[EUROPEAN_INTEGRATION_EFFECT_NOT_INCREASING]$EUROPEAN_INTEGRATION_EFFECT_NOT_INCREASING$]
		}
		[[EFFECT_AFTER]$EFFECT_AFTER$]
	}
	else_if = {
		limit = {
			to_has_tribal_integration = yes
		}
		[[EFFECT]$EFFECT$]
		[[TRIBAL_INTEGRATION_EFFECT]$TRIBAL_INTEGRATION_EFFECT$]
		if = {
			limit = {
				to_culture_assimilation_increasing = yes
			}
			[[EFFECT_INCREASING]$EFFECT_INCREASING$]
			[[TRIBAL_INTEGRATION_EFFECT_INCREASING]$TRIBAL_INTEGRATION_EFFECT_INCREASING$]
		}
		else = {
			[[EFFECT_NOT_INCREASING]$EFFECT_NOT_INCREASING$]
			[[TRIBAL_INTEGRATION_EFFECT_NOT_INCREASING]$TRIBAL_INTEGRATION_EFFECT_NOT_INCREASING$]
		}
		[[EFFECT_AFTER]$EFFECT_AFTER$]
	}
	else = {
		[[EFFECT_NO_ASSIMILATION]
		$EFFECT_NO_ASSIMILATION$
		]
	}
}

to_culture_adaptation_progress_routine = {
	every_country = {
		limit = {
			# any_owned_province = {
			# 	to_has_culture_adaptation_potential = yes
			# }
			# This should filter out most countries
			# OR = {
			# 	to_enabled_european_culture_integration = yes
			# 	to_enabled_greek_integration = yes
			# 	any_owned_province = {
			# 		is_city = yes
			# 		OR = {
			# 			continent = north_america
			# 			continent = south_america
			# 		}
			# 	}
			# }
		}
		save_event_target_as = to_culture_assimilation_owner
		every_owned_province = {
			limit = {
				to_has_culture_adaptation_potential = yes
			}
			to_generic_adaptation_types_effect = {
				EFFECT = "set_province_flag = to_assimilation_active"
				ASSIMIATION_EFFECT_INCREASING = "
				to_increase_culture_adaptation_progress_general = { 
					OWNER_TARGET = to_culture_assimilation_owner
					SPECIFIC_PROGRESS_INCREASE = to_culture_assimilation_progress
				}"
				GREEK_INTEGRATION_EFFECT_INCREASING = "
				to_increase_culture_adaptation_progress_general = { 
					OWNER_TARGET = to_culture_assimilation_owner
					SPECIFIC_PROGRESS_INCREASE = to_greek_integration_progress
				}"
				EUROPEAN_INTEGRATION_EFFECT_INCREASING = "
				to_increase_culture_adaptation_progress_general = { 
					OWNER_TARGET = to_culture_assimilation_owner
					SPECIFIC_PROGRESS_INCREASE = to_culture_integration_progress
				}"
				TRIBAL_INTEGRATION_EFFECT_INCREASING = "
				to_increase_culture_adaptation_progress_general = { 
					OWNER_TARGET = to_culture_assimilation_owner
					SPECIFIC_PROGRESS_INCREASE = to_tribal_integration_progress
				}"
				EFFECT_NOT_INCREASING = "to_culture_adaptation_inactive_setup = yes"
				EFFECT_AFTER = "to_trigger_culture_adaptation_events = yes"
				EFFECT_NO_ASSIMILATION = "
				if = {
					limit = {
						has_province_flag = to_assimilation_active
					}
					to_remove_culture_adaptation_variables = yes
				}
				"
			}
		}
	}
}

to_culture_adaptation_inactive_setup = {
	if = {
		limit = {
			is_variable_equal = {
				which = to_assimilation_progress
				value = 0
			}
		}
		set_variable = {
			which = to_assimilation_progress
			value = 0
		}
	}
	clr_province_flag = to_assimilation_progressing
}

to_increase_culture_adaptation_progress_general = {
	set_variable = {
		which = to_assimilation_flat_increase
		value = 0
	}
	set_variable = {
		which = to_assimilation_modifier
		value = 1
	}
	
	$SPECIFIC_PROGRESS_INCREASE$ = { OWNER_TARGET = $OWNER_TARGET$ }

	set_variable = {
		which = to_assimilation_base_total
		which = to_assimilation_flat_increase
	}
	divide_variable = {
		which = to_assimilation_flat_increase
		value = 12
	}
	set_variable = {
		which = to_assimilation_increase
		which = to_assimilation_flat_increase
	}
	if = {
		limit = {
			NOT = {
				check_variable = {
					which = to_assimilation_modifier
					value = -0.90
				}
			}
		}
		set_variable = {
			which = to_assimilation_modifier
			value = -0.90
		}
	}
	multiply_variable = {
		which = to_assimilation_increase
		which = to_assimilation_modifier
	}

	if = {
		limit = {
			NOT = {
				check_variable = {
					which = to_assimilation_increase
					value = 0
				}
			}
		}
		set_variable = {
			which = to_assimilation_increase
			value = 0
		}
	}

	change_variable = {
		which = to_assimilation_progress
		which = to_assimilation_increase
	}

	if = {
		limit = {
			check_variable = {
				which = to_assimilation_progress
				value = 100
			}
			NOT = { has_province_flag = to_block_culture_integration_completion }
		}
		to_adapt_province_culture = { OWNER_TARGET = $OWNER_TARGET$ }
	}
	else = {
		set_province_flag = to_assimilation_progressing
		# Display only
		set_variable = {
			which = to_assimilation_progress_display
			which = to_assimilation_progress
		}
		to_round_down_variable_one_decimal = { VARIABLE = to_assimilation_progress_display }
		set_variable = {
			which = to_assimilation_remaining_months
			value = 100
		}
		subtract_variable = {
			which = to_assimilation_remaining_months
			which = to_assimilation_progress
		}
		divide_variable = {
			which = to_assimilation_remaining_months
			which = to_assimilation_increase
		}
		to_round_up_variable = { VARIABLE = to_assimilation_remaining_months }
		set_variable = {
			which = to_assimilation_remaining_years
			which = to_assimilation_remaining_months
		}
		divide_variable = {
			which = to_assimilation_remaining_years
			value = 12
		}
		to_round_up_variable = { VARIABLE = to_assimilation_remaining_years }

		set_variable = {
			which = to_assimilation_increase_yearly
			which = to_assimilation_increase
		}
		multiply_variable = {
			which = to_assimilation_increase_yearly
			value = 12
		}
		to_round_down_variable_one_decimal = { VARIABLE = to_assimilation_increase_yearly }
		# multiply_variable = {
		# 	which = to_assimilation_neighboring_provinces
		# 	value = 12
		# }
		# multiply_variable = {
		# 	which = to_assimilation_base
		# 	value = 12
		# }
		change_variable = {
			which = to_assimilation_modifier
			value = -1
		}
		multiply_variable = {
			which = to_assimilation_modifier
			value = 100
		}
		set_province_flag = to_assimilation_active
	}
}

to_culture_assimilation_progress = {
	set_variable = {
		which = to_assimilation_base
		value = 3
	}
	change_variable = {
		which = to_assimilation_flat_increase
		which = to_assimilation_base
	}
	# From Neighboring Provinces
	set_variable = {
		which = to_assimilation_neighboring_provinces
		value = 0
	}
	every_neighbor_province = {
		limit = {
			is_city = yes
			# country_or_subject_holds = event_target:$OWNER_TARGET$
			event_target:$OWNER_TARGET$ = {
				culture_group = PREV
			}
		}
		PREV = {
			change_variable = {
				which = to_assimilation_neighboring_provinces
				value = 0.15
			}
		}
	}
	change_variable = {
		which = to_assimilation_flat_increase
		which = to_assimilation_neighboring_provinces
	}

	# A country in the new world in the same culture (group has a core on the province
	clr_province_flag = to_new_world_core
	if = {
		limit = {
			OR = {
				continent = north_america
				continent = south_america
			}
			any_core_country = {
				exists = yes
				is_subject = no
				NOT = { owns = PREV }
				culture_group = PREV
				capital_scope = {
					OR = {
						continent = north_america
						continent = south_america
					}
				}
			}
		}
		set_province_flag = to_new_world_core
		change_variable = {
			which = to_assimilation_flat_increase
			value = -2
		}
	}

	# Modifiers
	clr_province_flag = to_tribal_assimilation_native_estate_modifiers
	clr_province_flag = to_tribal_assimilation_settlers_enabled
	clr_province_flag = to_tribal_assimilation_service_enabled
	clr_province_flag = to_tribal_assimilation_officials_enabled
	clr_province_flag = to_tribal_assimilation_citizenship_enabled
	clr_province_flag = to_tribal_assimilation_native_assimilation_enabled
	clr_province_flag = to_culture_assimilation_recruitment_quotas_enabled
	clr_province_flag = to_assimilation_culture_accepted
	set_variable = {
		which = to_assimilation_development
		value = 0
	}
	export_to_variable = {
		variable_name = to_assimilation_development
		value = trigger_value:development
	}
	multiply_variable = {
		which = to_assimilation_development
		value = -0.025
	}
	if = {
		limit = {
			NOT = {
				check_variable = {
					which = to_assimilation_development
					value = -0.5
				}
			}
		}
		set_variable = {
			which = to_assimilation_development
			value = -0.5
		}
	}
	change_variable = {
		which = to_assimilation_modifier
		which = to_assimilation_development
	}
	multiply_variable = {
		which = to_assimilation_development
		value = 100
	}
	# Improved by owner
	export_to_variable = {
		variable_name = to_assimilation_improved_by_owner
		value = trigger_value:num_of_times_improved_by_owner
	}
	multiply_variable = {
		which = to_assimilation_improved_by_owner
		value = 0.05
	}
	change_variable = {
		which = to_assimilation_modifier
		which = to_assimilation_improved_by_owner
	}
	multiply_variable = {
		which = to_assimilation_improved_by_owner
		value = 100
	}
	# Modifiers
	if = {
		limit = {
			owner = {
				OR = {
					has_country_modifier = nhs_handicap_settlers
					AND = {
						is_subject = yes
						overlord = {
							has_country_modifier = nhs_handicap_settlers
						}
						OR = {
							is_colonial_nation = yes
							technology_group = exiled_greek
						}
					}
				}
			}
		}
		change_variable = {
			which = to_assimilation_modifier
			value = -0.25
		}
		set_province_flag = to_tribal_assimilation_settlers_enabled
	}
	if = {
		limit = {
			owner = {
				has_estate = estate_all_natives
			}
			OR = {
				culture = elysameric
				culture = skraeling
				to_nat_tribal_native_culture_province = yes
			}
		}
		set_province_flag = to_tribal_assimilation_native_estate_modifiers
		if = {
			limit = {
				owner = {
					has_estate_privilege = nhs_native_priv_citizenship_for_service
				}
			}
			change_variable = {
				which = to_assimilation_modifier
				value = 0.10
			}
			set_province_flag = to_tribal_assimilation_service_enabled
		}
		if = {
			limit = {
				owner = {
					OR = {
						has_estate_privilege = nhs_native_priv_encourage_barbaroi_officials
						has_estate_privilege = to_vov_native_priv_open_ranks
					}
				}
			}
			change_variable = {
				which = to_assimilation_modifier
				value = 0.25
			}
			set_province_flag = to_tribal_assimilation_officials_enabled
		}
		if = {
			limit = {
				owner = {
					OR = {
						has_estate_privilege = nhs_native_priv_inclusive_citizenship_early
						has_estate_privilege = nhs_native_priv_inclusive_citizenship_mid
						has_estate_privilege = to_vov_native_priv_benevolent_conquerors
					}
				}
			}
			change_variable = {
				which = to_assimilation_modifier
				value = 0.25
			}
			set_province_flag = to_tribal_assimilation_citizenship_enabled
		}
	}
	# Recruitment Quotas
	if = {
		limit = {
			owner = {
				has_country_modifier = to_janissary_recruitment_quotas
			}
		}
		change_variable = {
			which = to_assimilation_modifier
			value = -0.25
		}
		set_province_flag = to_culture_assimilation_recruitment_quotas_enabled
	}
	# Accepted culture
	save_event_target_as = to_assimilation_province
	if = {
		limit = {
			owner = {
				accepted_culture = event_target:to_assimilation_province
				NOT = { culture_group = event_target:to_assimilation_province }
			}
		}
		set_province_flag = to_assimilation_culture_accepted
		change_variable = {
			which = to_assimilation_modifier
			value = 0.25
		}
	}
	# Culture conversion cost
	export_to_variable = {
		which = to_culture_conversion_cost
		value = modifier:culture_conversion_cost
		who = event_target:$OWNER_TARGET$
	}
	export_to_variable = {
		which = to_local_culture_conversion_cost
		value = modifier:local_culture_conversion_cost
	}
	change_variable = {
		which = to_culture_conversion_cost
		which = to_local_culture_conversion_cost
	}
	multiply_variable = {
		which = to_culture_conversion_cost
		value = -1
	}
	change_variable = {
		which = to_assimilation_modifier
		which = to_culture_conversion_cost
	}
	# divide_variable = {
	# 	which = to_culture_conversion_cost
	# 	value = -2
	# }
	multiply_variable = {
		which = to_culture_conversion_cost
		value = 100
	}
	# Native Assimilation (divided by 4)
	if = {
		limit = {
			OR = {
				culture = elysameric
				culture = skraeling
				to_nat_tribal_native_culture_province = yes
			}
		}
		set_province_flag = to_tribal_assimilation_native_assimilation_enabled
		export_to_variable = {
			which = to_native_assimilation
			value = modifier:native_assimilation
			who = event_target:$OWNER_TARGET$
		}
		divide_variable = {
			which = to_native_assimilation
			value = 4
		}
		change_variable = {
			which = to_assimilation_modifier
			which = to_native_assimilation
		}
		multiply_variable = {
			which = to_native_assimilation
			value = 100
		}
	}
}

to_greek_integration_progress = {
	set_variable = {
		which = to_assimilation_base
		value = 5
	}
	change_variable = {
		which = to_assimilation_flat_increase
		which = to_assimilation_base
	}

	clr_province_flag = to_a_new_hope_completed
	clr_province_flag = to_culture_adaptation_heathen
	clr_province_flag = to_culture_adaptation_heathen_overlord
	clr_province_flag = to_culture_adaptation_heretic
	clr_province_flag = to_culture_adaptation_heretic_overlord
	clr_province_flag = to_culture_assimilation_recruitment_quotas_enabled
	
	set_variable = {
		which = to_assimilation_development
		value = 0
	}
	export_to_variable = {
		variable_name = to_assimilation_development
		value = trigger_value:development
	}
	multiply_variable = {
		which = to_assimilation_development
		value = -0.025
	}
	if = {
		limit = {
			NOT = {
				check_variable = {
					which = to_assimilation_development
					value = -0.50
				}
			}
		}
		set_variable = {
			which = to_assimilation_development
			value = -0.50
		}
	}
	change_variable = {
		which = to_assimilation_modifier
		which = to_assimilation_development
	}
	multiply_variable = {
		which = to_assimilation_development
		value = 100
	}
	# Improved by owner
	export_to_variable = {
		variable_name = to_assimilation_improved_by_owner
		value = trigger_value:num_of_times_improved_by_owner
	}
	multiply_variable = {
		which = to_assimilation_improved_by_owner
		value = 0.05
	}
	change_variable = {
		which = to_assimilation_modifier
		which = to_assimilation_improved_by_owner
	}
	multiply_variable = {
		which = to_assimilation_improved_by_owner
		value = 100
	}
	# Separatism penalty
	set_variable = {
		which = to_assimilation_separatism
		value = 0
	}
	export_to_variable = {
		variable_name = to_assimilation_separatism
		value = trigger_value:nationalism
	}
	# 1 Year of Separatism = 0.5 Unrest
	multiply_variable = {
		which = to_assimilation_separatism
		value = -0.005
	}
	if = {
		limit = {
			NOT = {
				check_variable = {
					which = to_assimilation_separatism
					value = -0.50
				}
			}
		}
		set_variable = {
			which = to_assimilation_separatism
			value = -0.50
		}
	}
	multiply_variable = {
		which = to_assimilation_separatism
		value = 100
	}
	# A New Hope completed
	if = {
		limit = {
			owner = {
				OR = {
					mission_completed = to_a_new_hope_mission
					AND = {
						is_subject = yes
						overlord = {
							mission_completed = to_a_new_hope_mission
						}
					}
				}
			}
		}
		set_province_flag = to_a_new_hope_completed
		change_variable = {
			which = to_assimilation_modifier
			value = 0.5
		}
	}
	# Local religion, used to be penlties but we got enough of those already
	# Same religion
	save_event_target_as = to_assimilation_province
	if = {
		limit = {
			owner = {
				to_has_cultureshock_country = yes
				religion = PREV
			}
		}
		set_province_flag = to_culture_adaptation_same_religion
		change_variable = {
			which = to_assimilation_modifier
			value = 0.20
		}
	}
	else_if = {
		limit = {
			owner = {
				is_subject = yes
				overlord = {
					to_has_cultureshock_country = yes
					religion = event_target:to_assimilation_province
				}
			}
		}
		set_province_flag = to_culture_adaptation_same_religion_overlord
		change_variable = {
			which = to_assimilation_modifier
			value = 0.20
		}
	}
	# Follows different religion (heretic)
	else_if = {
		limit = {
			owner = {
				to_has_cultureshock_country = yes
				religion_group = PREV
			}
		}
		set_province_flag = to_culture_adaptation_same_religion_group
		change_variable = {
			which = to_assimilation_modifier
			value = 0.10
		}
	}
	else_if = {
		limit = {
			owner = {
				is_subject = yes
				overlord = {
					to_has_cultureshock_country = yes
					religion_group = event_target:to_assimilation_province
				}
			}
		}
		set_province_flag = to_culture_adaptation_same_religion_group_overlord
		change_variable = {
			which = to_assimilation_modifier
			value = 0.10
		}
	}
	# Follows different religion (heathen)
	# if = {
	# 	limit = {
	# 		owner = {
	# 			to_has_cultureshock_country = yes
	# 			NOT = { religion_group = PREV }
	# 		}
	# 	}
	# 	set_province_flag = to_culture_adaptation_heathen
	# 	change_variable = {
	# 		which = to_assimilation_modifier
	# 		value = -0.25
	# 	}
	# }
	# else_if = {
	# 	limit = {
	# 		owner = {
	# 			is_subject = yes
	# 			overlord = {
	# 				to_has_cultureshock_country = yes
	# 				NOT = { religion_group = PREV }
	# 			}
	# 		}
	# 	}
	# 	set_province_flag = to_culture_adaptation_heathen_overlord
	# 	change_variable = {
	# 		which = to_assimilation_modifier
	# 		value = -0.25
	# 	}
	# }
	# # Follows different religion (heretic)
	# else_if = {
	# 	limit = {
	# 		owner = {
	# 			to_has_cultureshock_country = yes
	# 			NOT = { religion = PREV }
	# 		}
	# 	}
	# 	set_province_flag = to_culture_adaptation_heretic
	# 	change_variable = {
	# 		which = to_assimilation_modifier
	# 		value = -0.15
	# 	}
	# }
	# else_if = {
	# 	limit = {
	# 		owner = {
	# 			is_subject = yes
	# 			overlord = {
	# 				to_has_cultureshock_country = yes
	# 				NOT = { religion = PREV }
	# 			}
	# 		}
	# 	}
	# 	set_province_flag = to_culture_adaptation_heretic_overlord
	# 	change_variable = {
	# 		which = to_assimilation_modifier
	# 		value = -0.15
	# 	}
	# }
	# Culture Shock modifiers
	# if = {
	# 	limit = {
	# 		has_province_modifier = to_cultureshock_vbad
	# 	}
	# 	set_province_flag = to_integration_cultureshock_vbad
	# 	change_variable = {
	# 		which = to_assimilation_modifier
	# 		value = -0.50
	# 	}
	# }
	# else_if = {
	# 	limit = {
	# 		has_province_modifier = to_cultureshock_bad
	# 	}
	# 	set_province_flag = to_integration_cultureshock_bad
	# 	change_variable = {
	# 		which = to_assimilation_modifier
	# 		value = -0.35
	# 	}
	# }
	# else_if = {
	# 	limit = {
	# 		has_province_modifier = to_cultureshock_medium
	# 	}
	# 	set_province_flag = to_integration_cultureshock_medium
	# 	change_variable = {
	# 		which = to_assimilation_modifier
	# 		value = -0.20
	# 	}
	# }
	# else_if = {
	# 	limit = {
	# 		has_province_modifier = to_cultureshock_light
	# 	}
	# 	set_province_flag = to_integration_cultureshock_light
	# 	change_variable = {
	# 		which = to_assimilation_modifier
	# 		value = -0.10
	# 	}
	# }
	# Recruitment Quotas
	if = {
		limit = {
			owner = {
				has_country_modifier = to_janissary_recruitment_quotas
			}
		}
		change_variable = {
			which = to_assimilation_modifier
			value = -0.25
		}
		set_province_flag = to_culture_assimilation_recruitment_quotas_enabled
	}
	# Culture conversion cost
	export_to_variable = {
		which = to_culture_conversion_cost
		value = modifier:culture_conversion_cost
		who = event_target:$OWNER_TARGET$
	}
	export_to_variable = {
		which = to_local_culture_conversion_cost
		value = modifier:local_culture_conversion_cost
	}
	change_variable = {
		which = to_culture_conversion_cost
		which = to_local_culture_conversion_cost
	}
	multiply_variable = {
		which = to_culture_conversion_cost
		value = -1
	}
	# divide_variable = {
	# 	which = to_culture_conversion_cost
	# 	value = -2
	# }
	change_variable = {
		which = to_assimilation_modifier
		which = to_culture_conversion_cost
	}
	multiply_variable = {
		which = to_culture_conversion_cost
		value = 100
	}
}

to_culture_integration_progress = {
	set_variable = {
		which = to_assimilation_base
		value = 3
	}
	change_variable = {
		which = to_assimilation_flat_increase
		which = to_assimilation_base
	}
	set_variable = {
		which = to_assimilation_neighboring_provinces
		value = 0
	}

	clr_province_flag = to_culture_integration_triumph_completed
	clr_province_flag = to_culture_assimilation_recruitment_quotas_enabled
	clr_province_flag = to_assimilation_culture_accepted
	clr_province_flag = to_assimilation_culture_accepted_overlord
	every_neighbor_province = {
		limit = {
			is_city = yes
			OR = {
				culture_group = event_target:$OWNER_TARGET$
				AND = {
					to_has_culture_integrated = yes
					culture_group = PREV
				}
			}
		}
		PREV = {
			change_variable = {
				which = to_assimilation_neighboring_provinces
				value = 0.15
			}
		}
	}
	change_variable = {
		which = to_assimilation_flat_increase
		which = to_assimilation_neighboring_provinces
	}
	
	set_variable = {
		which = to_assimilation_development
		value = 0
	}
	export_to_variable = {
		variable_name = to_assimilation_development
		value = trigger_value:development
	}
	multiply_variable = {
		which = to_assimilation_development
		value = -0.025
	}
	if = {
		limit = {
			NOT = {
				check_variable = {
					which = to_assimilation_development
					value = -0.5
				}
			}
		}
		set_variable = {
			which = to_assimilation_development
			value = -0.5
		}
	}
	change_variable = {
		which = to_assimilation_modifier
		which = to_assimilation_development
	}
	multiply_variable = {
		which = to_assimilation_development
		value = 100
	}
	# Improved by owner
	export_to_variable = {
		variable_name = to_assimilation_improved_by_owner
		value = trigger_value:num_of_times_improved_by_owner
	}
	multiply_variable = {
		which = to_assimilation_improved_by_owner
		value = 0.05
	}
	change_variable = {
		which = to_assimilation_modifier
		which = to_assimilation_improved_by_owner
	}
	multiply_variable = {
		which = to_assimilation_improved_by_owner
		value = 100
	}
	# Triumph completed
	if = {
		limit = {
			has_province_modifier = to_triumph_warscore_cost_red
		}
		set_province_flag = to_culture_integration_triumph_completed
		change_variable = {
			which = to_assimilation_modifier
			value = 0.5
		}
	}
	# Accepted culture
	save_event_target_as = to_assimilation_province
	if = {
		limit = {
			owner = {
				to_enabled_european_culture_integration_specific = yes
			}
		}
		if = {
			limit = {
				owner = {
					accepted_culture = event_target:to_assimilation_province
				}
			}
			set_province_flag = to_assimilation_culture_accepted
			change_variable = {
				which = to_assimilation_modifier
				value = 0.25
			}
		}
	}
	else_if = {
		limit = {
			owner = {
				is_subject = yes
			}
		}
		set_province_flag = to_assimilation_culture_accepted_overlord
		if = {
			limit = {
				owner = {
					overlord = {
						accepted_culture = event_target:to_assimilation_province
					}
				}
			}
			set_province_flag = to_assimilation_culture_accepted
			change_variable = {
				which = to_assimilation_modifier
				value = 0.25
			}
		}
	}
	# Recruitment Quotas
	if = {
		limit = {
			owner = {
				has_country_modifier = to_janissary_recruitment_quotas
			}
		}
		change_variable = {
			which = to_assimilation_modifier
			value = -0.25
		}
		set_province_flag = to_culture_assimilation_recruitment_quotas_enabled
	}
	# Culture conversion cost
	export_to_variable = {
		which = to_culture_conversion_cost
		value = modifier:culture_conversion_cost
		who = event_target:$OWNER_TARGET$
	}
	export_to_variable = {
		which = to_local_culture_conversion_cost
		value = modifier:local_culture_conversion_cost
	}
	change_variable = {
		which = to_culture_conversion_cost
		which = to_local_culture_conversion_cost
	}
	multiply_variable = {
		which = to_culture_conversion_cost
		value = -1
	}
	# divide_variable = {
	# 	which = to_culture_conversion_cost
	# 	value = -2
	# }
	change_variable = {
		which = to_assimilation_modifier
		which = to_culture_conversion_cost
	}
	multiply_variable = {
		which = to_culture_conversion_cost
		value = 100
	}
}

to_tribal_integration_progress = {
	set_variable = {
		which = to_assimilation_base
		value = 3
	}
	change_variable = {
		which = to_assimilation_flat_increase
		which = to_assimilation_base
	}
	set_variable = {
		which = to_assimilation_neighboring_provinces
		value = 0
	}
	every_neighbor_province = {
		limit = {
			is_city = yes
			# country_or_subject_holds = event_target:$OWNER_TARGET$
			culture_group = event_target:$OWNER_TARGET$
		}
		PREV = {
			change_variable = {
				which = to_assimilation_neighboring_provinces
				value = 0.15
			}
		}
	}
	change_variable = {
		which = to_assimilation_flat_increase
		which = to_assimilation_neighboring_provinces
	}

	set_province_flag = to_assimilation_progressing_tribal
	clr_province_flag = to_tribal_assimilation_native_estate_modifiers
	clr_province_flag = to_tribal_assimilation_settlers_enabled
	clr_province_flag = to_tribal_assimilation_service_enabled
	clr_province_flag = to_tribal_assimilation_officials_enabled
	clr_province_flag = to_tribal_assimilation_citizenship_enabled
	clr_province_flag = to_culture_assimilation_recruitment_quotas_enabled
	set_variable = {
		which = to_assimilation_development
		value = 0
	}
	if = {
		limit = {
			NOT = {
				is_variable_equal = {
					which = to_nat_local_tribal_development
					value = 0
				}
			}
		}
		set_variable = {
			which = to_assimilation_development
			which = to_nat_local_tribal_development
		}
		multiply_variable = {
			which = to_assimilation_development
			value = -0.025
		}
	}
	if = {
		limit = {
			NOT = {
				check_variable = {
					which = to_assimilation_development
					value = -0.5
				}
			}
		}
		set_variable = {
			which = to_assimilation_development
			value = -0.5
		}
	}
	change_variable = {
		which = to_assimilation_modifier
		which = to_assimilation_development
	}
	multiply_variable = {
		which = to_assimilation_development
		value = 100
	}
	if = {
		limit = {
			owner = {
				OR = {
					has_country_modifier = nhs_handicap_settlers
					AND = {
						is_subject = yes
						overlord = {
							has_country_modifier = nhs_handicap_settlers
						}
						OR = {
							is_colonial_nation = yes
							technology_group = exiled_greek
						}
					}
				}
			}
		}
		change_variable = {
			which = to_assimilation_modifier
			value = -0.25
		}
		set_province_flag = to_tribal_assimilation_settlers_enabled
	}
	if = {
		limit = {
			owner = {
				has_estate = estate_all_natives
			}
		}
		set_province_flag = to_tribal_assimilation_native_estate_modifiers
		if = {
			limit = {
				owner = {
					has_estate_privilege = nhs_native_priv_citizenship_for_service
				}
			}
			change_variable = {
				which = to_assimilation_modifier
				value = 0.10
			}
			set_province_flag = to_tribal_assimilation_service_enabled
		}
		if = {
			limit = {
				owner = {
					OR = {
						has_estate_privilege = nhs_native_priv_encourage_barbaroi_officials
						has_estate_privilege = to_vov_native_priv_open_ranks
					}
				}
			}
			change_variable = {
				which = to_assimilation_modifier
				value = 0.25
			}
			set_province_flag = to_tribal_assimilation_officials_enabled
		}
		if = {
			limit = {
				owner = {
					OR = {
						has_estate_privilege = nhs_native_priv_inclusive_citizenship_early
						has_estate_privilege = nhs_native_priv_inclusive_citizenship_mid
						has_estate_privilege = to_vov_native_priv_benevolent_conquerors
					}
				}
			}
			change_variable = {
				which = to_assimilation_modifier
				value = 0.25
			}
			set_province_flag = to_tribal_assimilation_citizenship_enabled
		}
	}
	# Recruitment Quotas
	if = {
		limit = {
			owner = {
				has_country_modifier = to_janissary_recruitment_quotas
			}
		}
		change_variable = {
			which = to_assimilation_modifier
			value = -0.25
		}
		set_province_flag = to_culture_assimilation_recruitment_quotas_enabled
	}
	# Culture conversion cost
	export_to_variable = {
		which = to_culture_conversion_cost
		value = modifier:culture_conversion_cost
		who = event_target:$OWNER_TARGET$
	}
	export_to_variable = {
		which = to_local_culture_conversion_cost
		value = modifier:local_culture_conversion_cost
	}
	change_variable = {
		which = to_culture_conversion_cost
		which = to_local_culture_conversion_cost
	}
	multiply_variable = {
		which = to_culture_conversion_cost
		value = -1
	}
	# divide_variable = {
	# 	which = to_culture_conversion_cost
	# 	value = -2
	# }
	# Native Assimilation (divided by 4)
	export_to_variable = {
		which = to_native_assimilation
		value = modifier:native_assimilation
		who = event_target:$OWNER_TARGET$
	}
	divide_variable = {
		which = to_native_assimilation
		value = 4
	}

	change_variable = {
		which = to_assimilation_modifier
		which = to_culture_conversion_cost
	}
	change_variable = {
		which = to_assimilation_modifier
		which = to_native_assimilation
	}

	multiply_variable = {
		which = to_culture_conversion_cost
		value = 100
	}
	multiply_variable = {
		which = to_native_assimilation
		value = 100
	}
}

to_adapt_province_culture = {
	to_remove_culture_adaptation_variables = yes
	if = {
		limit = {
			to_has_culture_assimilation = yes
		}
		if = {
			limit = {
				to_has_albanian_assimilation = yes
			}
			change_culture = shqipproi
		}
		else_if = {
			limit = {
				owner = {
					culture_group = byzantine
				}
				OR = {
					NOT = { culture_group = byzantine }
					culture = elysameric
				}
			}
			to_adapt_province_culture_roman = yes
		}
		else_if = {
			limit = {
				owner = {
					culture_group = norse_g
				}
				OR = {
					NOT = { culture_group = norse_g }
					culture = skraeling
				}
			}
			if = {
				limit = {
					culture = skraeling
				}
				if = {
					limit = {
						owner = {
							has_country_flag = to_disabled_assimilation_notifications
						}
					}
					to_nat_assimilate_local_tribal_development = yes
					to_nhs_assign_correct_vinlandic_culture = yes
				}
				if = {
					limit = {
						owner = {
							NOT = { has_country_flag = to_disabled_assimilation_notifications }
						}
					}
					set_province_flag = to_trigger_nhs_vov_culture_3
				}
			}
			else_if = {
				limit = {
					to_nat_tribal_native_culture_province = yes
				}
				if = {
					limit = {
						owner = {
							has_country_flag = to_disabled_assimilation_notifications
						}
					}
					to_nat_assimilate_local_tribal_development = yes
					change_culture = skraeling
				}
				if = {
					limit = {
						owner = {
							NOT = { has_country_flag = to_disabled_assimilation_notifications }
						}
					}
					set_province_flag = to_trigger_nhs_vov_culture_2
				}
			}
			else = {
				to_nhs_assign_correct_vinlandic_culture = yes
			}
		}
		else_if = {
			limit = {
				owner = {
					NOT = { culture_group = byzantine }
					NOT = { culture_group = norse_g }
				}
				NOT = { culture_group = event_target:$OWNER_TARGET$ }
			}
			if = {
				limit = {
					to_nat_tribal_native_culture_province = yes
				}
				to_nat_assimilate_local_tribal_development = yes
			}
			change_culture = event_target:$OWNER_TARGET$
		}
	}
	else_if = {
		limit = {
			to_has_greek_integration = yes
		}
		set_province_flag = to_greeks_integrated_flag
		add_nationalism = -100
		to_remove_cultureshock_modifiers = yes
	}
	else_if = {
		limit = {
			to_has_european_culture_integration = yes
		}
		set_province_flag = to_culture_integrated_flag
		to_add_appropriate_culture_integration_modifier = yes
	}
	else_if = {
		limit = {
			to_has_tribal_integration = yes
		}
		to_nat_assimilate_local_tribal_development = yes
	}
}

to_trigger_culture_adaptation_events = {
	# So why this? Becuase our overlords at the small indea dev company have so far been unable or unwilling to fix a bug where you cannot trigger an event in the else_if or else of a scripted effect
	if = {
		limit = {
			has_province_flag = to_trigger_nhs2_cultureevents_103
		}
		clr_province_flag = to_trigger_nhs2_cultureevents_103
		province_event = { id = nhs2_cultureevents.103 }
	}
	if = {
		limit = {
			has_province_flag = to_trigger_nhs2_cultureevents_24
		}
		clr_province_flag = to_trigger_nhs2_cultureevents_24
		province_event = { id = nhs2_cultureevents.24 }
	}
	if = {
		limit = {
			has_province_flag = to_trigger_nhs2_cultureevents_25
		}
		clr_province_flag = to_trigger_nhs2_cultureevents_25
		province_event = { id = nhs2_cultureevents.25 }
	}
	if = {
		limit = {
			has_province_flag = to_trigger_nhs2_cultureevents_26
		}
		clr_province_flag = to_trigger_nhs2_cultureevents_26
		province_event = { id = nhs2_cultureevents.26 }
	}
	if = {
		limit = {
			has_province_flag = to_trigger_nhs2_cultureevents_33
		}
		clr_province_flag = to_trigger_nhs2_cultureevents_33
		province_event = { id = nhs2_cultureevents.33 }
	}
	if = {
		limit = {
			has_province_flag = to_trigger_nhs2_cultureevents_35
		}
		clr_province_flag = to_trigger_nhs2_cultureevents_35
		province_event = { id = nhs2_cultureevents.35 }
	}
	if = {
		limit = {
			has_province_flag = to_trigger_nhs2_cultureevents_102
		}
		clr_province_flag = to_trigger_nhs2_cultureevents_102
		province_event = { id = nhs2_cultureevents.102 }
	}
	if = {
		limit = {
			has_province_flag = to_trigger_nhs2_cultureevents_201
		}
		clr_province_flag = to_trigger_nhs2_cultureevents_201
		province_event = { id = nhs2_cultureevents.201 }
	}
	if = {
		limit = {
			has_province_flag = to_trigger_nhs_vov_culture_3
		}
		clr_province_flag = to_trigger_nhs_vov_culture_3
		province_event = { id = nhs_vov_culture.3 }
	}
	if = {
		limit = {
			has_province_flag = to_trigger_nhs_vov_culture_2
		}
		clr_province_flag = to_trigger_nhs_vov_culture_2
		province_event = { id = nhs_vov_culture.2 }
	}
}

to_add_appropriate_culture_integration_modifier = {
	if = {
		limit = {
			owner = {
				to_has_exarch_government_reform = yes
			}
		}
		add_province_modifier = {
			name = to_culture_integrated_exarch
			duration = -1
		}
	}
	else_if = {
		limit = {
			OR = {
				has_owner_culture = yes
				has_owner_accepted_culture = yes
			}
		}
		add_province_modifier = {
			name = to_culture_integrated
			duration = -1
		}
	}
	else_if = {
		limit = {
			owner = {
				culture_group = PREV
			}
		}
		add_province_modifier = {
			name = to_culture_integrated_culture_group
			duration = -1
		}
	}
	else_if = {
		limit = {
			owner = {
				government = republic
			}
		}
		add_province_modifier = {
			name = to_culture_integrated_unaccepted_republic
			duration = -1
		}
	}
	else = {
		add_province_modifier = {
			name = to_culture_integrated_unaccepted
			duration = -1
		}
	}
}

to_remove_culture_integration_modifiers = {
	remove_province_modifier = to_culture_integrated
	remove_province_modifier = to_culture_integrated_exarch
	remove_province_modifier = to_culture_integrated_culture_group
	remove_province_modifier = to_culture_integrated_unaccepted_republic
	remove_province_modifier = to_culture_integrated_unaccepted
}

to_remove_culture_adaptation_variables = {
	clr_province_flag = to_tribal_assimilation_native_estate_modifiers
	clr_province_flag = to_tribal_assimilation_settlers_enabled
	clr_province_flag = to_tribal_assimilation_service_enabled
	clr_province_flag = to_tribal_assimilation_officials_enabled
	clr_province_flag = to_tribal_assimilation_citizenship_enabled
	clr_province_flag = to_tribal_assimilation_native_assimilation_enabled
	clr_province_flag = to_assimilation_active
	clr_province_flag = to_assimilation_progressing
	clr_province_flag = to_assimilation_progressing_tribal
	clr_province_flag = to_culture_integration_triumph_completed
	clr_province_flag = to_assimilation_culture_accepted
	clr_province_flag = to_assimilation_culture_accepted_overlord
	clr_province_flag = to_a_new_hope_completed
	clr_province_flag = to_culture_adaptation_heathen
	clr_province_flag = to_culture_adaptation_heathen_overlord
	clr_province_flag = to_culture_adaptation_heretic
	clr_province_flag = to_culture_adaptation_heretic_overlord
	clr_province_flag = to_culture_assimilation_recruitment_quotas_enabled
	set_variable = {
		which = to_assimilation_progress
		value = 0
	}
	set_variable = {
		which = to_assimilation_progress_display
		value = 0
	}
	set_variable = {
		which = to_assimilation_increase
		value = 0
	}
	set_variable = {
		which = to_assimilation_modifier
		value = 0
	}
	set_variable = {
		which = to_assimilation_flat_increase
		value = 0
	}
	set_variable = {
		which = to_native_assimilation
		value = 0
	}
	set_variable = {
		which = to_culture_conversion_cost
		value = 0
	}
	set_variable = {
		which = to_local_culture_conversion_cost
		value = 0
	}
	set_variable = {
		which = to_assimilation_remaining_months
		value = 0
	}
	set_variable = {
		which = to_assimilation_remaining_years
		value = 0
	}
	set_variable = {
		which = to_assimilation_increase_yearly
		value = 0
	}
	set_variable = {
		which = to_assimilation_neighboring_provinces
		value = 0
	}
	set_variable = {
		which = to_assimilation_base
		value = 0
	}
	set_variable = {
		which = to_assimilation_base_total
		value = 0
	}
	set_variable = {
		which = to_assimilation_development
		value = 0
	}
	set_variable = {
		which = to_assimilation_improved_by_owner
		value = 0
	}
	set_variable = {
		which = to_assimilation_separatism
		value = 0
	}
}