
to_remove_all_idea_groups = {
	remove_idea_group = development_ideas
	remove_idea_group = discovery_ideas
	remove_idea_group = domination_ideas
	remove_idea_group = aristocracy_ideas
	remove_idea_group = plutocracy_ideas
	remove_idea_group = horde_gov_ideas
	remove_idea_group = theocracy_gov_ideas
	remove_idea_group = indigenous_ideas
	remove_idea_group = innovativeness_ideas
	remove_idea_group = religious_ideas
	remove_idea_group = spy_ideas
	remove_idea_group = diplomatic_ideas
	remove_idea_group = offensive_ideas
	remove_idea_group = defensive_ideas
	remove_idea_group = trade_ideas
	remove_idea_group = economic_ideas
	remove_idea_group = exploration_ideas
	remove_idea_group = maritime_ideas
	remove_idea_group = quality_ideas
	remove_idea_group = quantity_ideas
	remove_idea_group = expansion_ideas
	remove_idea_group = administrative_ideas
	remove_idea_group = humanist_ideas
	remove_idea_group = influence_ideas
	remove_idea_group = naval_ideas
}

to_replace_idea_group_with_exploration = {
	remove_idea_group = $IDEA_GROUP$
	add_idea_group = exploration_ideas
}

to_replace_idea_group_with_exploration_keep_progress = {
	if = {
		limit = {
			has_idea_group = $IDEA_GROUP$
			NOT = { has_idea_group = exploration_ideas }
		}
		if = {
			limit = {
				$IDEA_GROUP$ = 7
			}
			to_replace_idea_group_with_exploration = { IDEA_GROUP = $IDEA_GROUP$ }
			add_idea = global_empire
		}
		else_if = {
			limit = {
				$IDEA_GROUP$ = 6
			}
			to_replace_idea_group_with_exploration = { IDEA_GROUP = $IDEA_GROUP$ }
			add_idea = free_colonies
		}
		else_if = {
			limit = {
				$IDEA_GROUP$ = 5
			}
			to_replace_idea_group_with_exploration = { IDEA_GROUP = $IDEA_GROUP$ }
			add_idea = vice_roys
		}
		else_if = {
			limit = {
				$IDEA_GROUP$ = 4
			}
			to_replace_idea_group_with_exploration = { IDEA_GROUP = $IDEA_GROUP$ }
			add_idea = land_of_opportunity
		}
		else_if = {
			limit = {
				$IDEA_GROUP$ = 3
			}
			to_replace_idea_group_with_exploration = { IDEA_GROUP = $IDEA_GROUP$ }
			add_idea = overseas_exploration
		}
		else_if = {
			limit = {
				$IDEA_GROUP$ = 2
			}
			to_replace_idea_group_with_exploration = { IDEA_GROUP = $IDEA_GROUP$ }
			add_idea = colonial_ventures
		}
		else_if = {
			limit = {
				$IDEA_GROUP$ = 1
			}
			to_replace_idea_group_with_exploration = { IDEA_GROUP = $IDEA_GROUP$ }
			add_idea = quest_for_the_new_world
		}
		else = {
			to_replace_idea_group_with_exploration = { IDEA_GROUP = $IDEA_GROUP$ }
		}
	}
}

to_replace_idea_group_with_exploration_for_ai = {
	if = {
		limit = {
			has_idea_group = spy_ideas
		}
		to_replace_idea_group_with_exploration_keep_progress = { IDEA_GROUP = spy_ideas }
	}
	else_if = {
		limit = {
			has_idea_group = maritime_ideas
		}
		to_replace_idea_group_with_exploration_keep_progress = { IDEA_GROUP = maritime_ideas }
	}
	else_if = {
		limit = {
			has_idea_group = indigenous_ideas
		}
		to_replace_idea_group_with_exploration_keep_progress = { IDEA_GROUP = indigenous_ideas }
	}
	else_if = {
		limit = {
			has_idea_group = administrative_ideas
			NOt = { full_idea_group = administrative_ideas }
		}
		to_replace_idea_group_with_exploration_keep_progress = { IDEA_GROUP = administrative_ideas }
	}
	else_if = {
		limit = {
			has_idea_group = influence_ideas
		}
		to_replace_idea_group_with_exploration_keep_progress = { IDEA_GROUP = influence_ideas }
	}
	else_if = {
		limit = {
			has_idea_group = diplomatic_ideas
		}
		to_replace_idea_group_with_exploration_keep_progress = { IDEA_GROUP = diplomatic_ideas }
	}
	else_if = {
		limit = {
			has_idea_group = innovativeness_ideas
		}
		to_replace_idea_group_with_exploration_keep_progress = { IDEA_GROUP = innovativeness_ideas }
	}
	else_if = {
		limit = {
			has_idea_group = trade_ideas
		}
		to_replace_idea_group_with_exploration_keep_progress = { IDEA_GROUP = trade_ideas }
	}
	else_if = {
		limit = {
			has_idea_group = economic_ideas
		}
		to_replace_idea_group_with_exploration_keep_progress = { IDEA_GROUP = economic_ideas }
	}
	else_if = {
		limit = {
			has_idea_group = humanist_ideas
		}
		to_replace_idea_group_with_exploration_keep_progress = { IDEA_GROUP = humanist_ideas }
	}
	else_if = {
		limit = {
			has_idea_group = religious_ideas
		}
		to_replace_idea_group_with_exploration_keep_progress = { IDEA_GROUP = religious_ideas }
	}
	else_if = {
		limit = {
			has_idea_group = plutocracy_ideas
		}
		to_replace_idea_group_with_exploration_keep_progress = { IDEA_GROUP = plutocracy_ideas }
	}
	else_if = {
		limit = {
			has_idea_group = horde_gov_ideas
		}
		to_replace_idea_group_with_exploration_keep_progress = { IDEA_GROUP = horde_gov_ideas }
	}
	else_if = {
		limit = {
			has_idea_group = theocracy_gov_ideas
		}
		to_replace_idea_group_with_exploration_keep_progress = { IDEA_GROUP = theocracy_gov_ideas }
	}
	else_if = {
		limit = {
			has_idea_group = aristocracy_ideas
		}
		to_replace_idea_group_with_exploration_keep_progress = { IDEA_GROUP = aristocracy_ideas }
	}
	else_if = {
		limit = {
			has_idea_group = naval_ideas
		}
		to_replace_idea_group_with_exploration_keep_progress = { IDEA_GROUP = naval_ideas }
	}
	else_if = {
		limit = {
			has_idea_group = offensive_ideas
		}
		to_replace_idea_group_with_exploration_keep_progress = { IDEA_GROUP = offensive_ideas }
	}
	else_if = {
		limit = {
			has_idea_group = defensive_ideas
		}
		to_replace_idea_group_with_exploration_keep_progress = { IDEA_GROUP = defensive_ideas }
	}
	else_if = {
		limit = {
			has_idea_group = quality_ideas
		}
		to_replace_idea_group_with_exploration_keep_progress = { IDEA_GROUP = quality_ideas }
	}
	else_if = {
		limit = {
			has_idea_group = quantity_ideas
		}
		to_replace_idea_group_with_exploration_keep_progress = { IDEA_GROUP = quantity_ideas }
	}
	else_if = {
		limit = {
			has_idea_group = expansion_ideas
		}
		to_replace_idea_group_with_exploration_keep_progress = { IDEA_GROUP = expansion_ideas }
	}
	else_if = {
		limit = {
			has_idea_group = administrative_ideas
		}
		to_replace_idea_group_with_exploration_keep_progress = { IDEA_GROUP = administrative_ideas }
	}
}

to_replace_idea_group_with_exploration_master_effect = {
	if = {
		limit = {
			NOT = { has_idea_group = exploration_ideas }
			to_there_is_a_switchable_idea_group = yes
		}
		if = {
			limit = {
				ai = no
			}
			if = {
				limit = {
					adm_tech = 5
					NOT = { adm_tech = 7 }
					OR = {
						has_idea_group = spy_ideas
						has_idea_group = maritime_ideas
						has_idea_group = indigenous_ideas
						has_idea_group = administrative_ideas
						has_idea_group = influence_ideas
						has_idea_group = diplomatic_ideas
						has_idea_group = innovativeness_ideas
						has_idea_group = trade_ideas
						has_idea_group = economic_ideas
						has_idea_group = humanist_ideas
						has_idea_group = religious_ideas
						has_idea_group = plutocracy_ideas
						has_idea_group = horde_gov_ideas
						has_idea_group = theocracy_gov_ideas
						has_idea_group = aristocracy_ideas
						has_idea_group = naval_ideas
						has_idea_group = offensive_ideas
						has_idea_group = defensive_ideas
						has_idea_group = quality_ideas
						has_idea_group = quantity_ideas
						has_idea_group = expansion_ideas
					}
				}
				# Also works for the player if they only have a single idea group
				to_replace_idea_group_with_exploration_for_ai = yes
			}
			if = {
				limit = {
					NOT = {
						AND = {
							adm_tech = 5
							NOT = { adm_tech = 7 }
							OR = {
								has_idea_group = spy_ideas
								has_idea_group = maritime_ideas
								has_idea_group = indigenous_ideas
								has_idea_group = administrative_ideas
								has_idea_group = influence_ideas
								has_idea_group = diplomatic_ideas
								has_idea_group = innovativeness_ideas
								has_idea_group = trade_ideas
								has_idea_group = economic_ideas
								has_idea_group = humanist_ideas
								has_idea_group = religious_ideas
								has_idea_group = plutocracy_ideas
								has_idea_group = horde_gov_ideas
								has_idea_group = theocracy_gov_ideas
								has_idea_group = aristocracy_ideas
								has_idea_group = naval_ideas
								has_idea_group = offensive_ideas
								has_idea_group = defensive_ideas
								has_idea_group = quality_ideas
								has_idea_group = quantity_ideas
								has_idea_group = expansion_ideas
							}
						}
					}
				}
				custom_tooltip = nhs_new_line_tt
				# custom_tooltip = to_event_to_switch_idea_groups_tt
				country_event = { id = to_colonialism_events.3 tooltip = to_event_to_switch_idea_groups_tt }
			}
		}
		else = {
			to_replace_idea_group_with_exploration_for_ai = yes
		}
	}
	else_if = {
		limit = {
			NOT = { has_idea_group = exploration_ideas }
			adm_tech = 5
		}
		add_idea_group = exploration_ideas
	}
}

to_trigger_colonialism_events_with_portugal = {
	every_country = {
		limit = {
			NOT = { tag = ROOT }
			to_eligible_for_exploration_event = yes
		}
		country_event = { id = to_colonialism_events.1 }
	}
	hidden_effect = {
		every_country = {
			limit = {
				nhs_check_all_elysian_tags = { CONDITION = tag }
			}
			country_event = { id = to_colonialism_events.4 }
		}
		every_country = {
			limit = {
				NOT = { tag = ROOT }
				NOT = { nhs_check_all_elysian_tags = { CONDITION = tag } }
				ai = no
				NOT = { to_eligible_for_exploration_event = yes }
			}
			if = {
				limit = {
					knows_country = ROOT
				}
				country_event = { id = institution_events.300 }
			}
			else = {
				country_event = { id = institution_events.301 }
			}
		}
	}
}

to_trigger_colonialism_events_no_portugal = {
	every_country = {
		limit = {
			NOT = { tag = ROOT }
			to_eligible_for_exploration_event = yes
		}
		country_event = { id = to_colonialism_events.2 }
	}
	hidden_effect = {
		every_country = {
			limit = {
				nhs_check_all_elysian_tags = { CONDITION = tag }
			}
			country_event = { id = to_colonialism_events.5 }
		}
		every_country = {
			limit = {
				NOT = { tag = ROOT }
				NOT = { nhs_check_all_elysian_tags = { CONDITION = tag } }
				ai = no
				NOT = { to_eligible_for_exploration_event = yes }
			}
			if = {
				limit = {
					knows_country = ROOT
				}
				country_event = { id = institution_events.300 }
			}
			else = {
				country_event = { id = institution_events.301 }
			}
		}
	}
}

to_trigger_colonialism_events_magellan = {
	every_country = {
		limit = {
			NOT = { tag = ROOT }
			to_eligible_for_exploration_event = yes
		}
		country_event = { id = to_colonialism_events.11 }
	}
	hidden_effect = {
		every_country = {
			limit = {
				NOT = { tag = ROOT }
				NOT = { nhs_check_all_elysian_tags = { CONDITION = tag } }
				ai = no
				NOT = { to_eligible_for_exploration_event = yes }
			}
			if = {
				limit = {
					knows_country = ROOT
				}
				country_event = { id = institution_events.300 }
			}
			else = {
				country_event = { id = institution_events.301 }
			}
		}
	}
}

to_birthplace_of_colonialism_effect = {
	add_adm_power = 100
	add_dip_power = 100
	add_mil_power = 100
	add_prestige = 20
	if = {
		limit = {
			NOT = { has_completed_all_reforms_trigger = yes }
		}
		add_reform_progress_medium_effect = yes
	}
	[[ADD_MAGELLAN_EFFECT]
	if =  {
		limit = { 
			has_dlc = "Rights of Man"
			NOT = { num_of_ruler_traits = { amount = 3 } }
			NOT = { ruler_has_personality = navigator_personality }
			has_regency = no
		}
		add_navy_tradition = 10
		add_ruler_personality = navigator_personality
	}
	else = { add_navy_tradition = 20 }
	]
	custom_tooltip = to_colonialism_spread_europe_tt
	custom_tooltip = institution_events.3.a.tt
	custom_tooltip = nhs_new_line_tt
	FROM = {
		add_permanent_province_modifier = {
			name = "birthplace_of_the_new_world"
			duration = -1
		}
		if = {
			limit = {
				owner = {
					has_country_modifier = nhs2_por_ely_trade
				}
			}
			tooltip = {
				add_permanent_province_modifier = {
					name = to_por_gateway_to_elysia
					duration = -1
				}
			}
			hidden_effect = {
				add_province_triggered_modifier = to_por_gateway_to_elysia_tm
			}
		}
	}
	[[ADD_MAGELLAN_EFFECT]
	define_explorer = {
		name = "Ferdinant Magellan"
		shock = 2
		fire = 1
		manuever = 6
		trait = accomplished_sailor_personality
	}
	]
}

to_discover_magellan_travels = {
	custom_tooltip = to_discover_magellan_travels_tt
	hidden_effect = {
		discover_province = 1566
		discover_province = 1578
		discover_province = 1581
		discover_province = 1576
		discover_province = 1566
		caribbean_sea_area = {
			discover_country = ROOT
		}
		carribeans_region = {
			limit = {
				has_port = yes
				NOT = { province_id = 481 }
			}
			discover_country = ROOT
		}
		if = {
			limit = {
				has_saved_event_target = to_magellan_landing
			}
			if = {
				limit = {
					event_target:to_magellan_landing = {
						OR = {
							province_id = 482
							province_id = 483
						}
					}
				}
				bahama_channel_area = {
					limit = {
						NOT = { province_id = 481 }
					}
					discover_country = ROOT
				}
			}
			else_if = {
				limit = {
					event_target:to_magellan_landing = {
						OR = {
							region = mississippi_region
							region = rio_grande_region
							region = mexico_region
							region = central_america_region
						}
					}
				}
				gulf_of_mexico_area = {
					limit = {
						NOT = { province_id = 481 }
					}
					discover_country = ROOT
				}
				if = {
					limit = {
						event_target:to_magellan_landing = {
							OR = {
								region = mexico_region
								region = central_america_region
							}
						}
					}
					every_province = {
						limit = {
							province_group = to_east_coast
							region = event_target:to_magellan_landing
							has_port = yes
						}
						discover_country = ROOT
					}
				}
				else = {
					every_province = {
						limit = {
							region = event_target:to_magellan_landing
							has_port = yes
						}
						discover_country = ROOT
					}
				}
			}
			else_if = {
				limit = {
					event_target:to_magellan_landing = {
						region = colombia_region
					}
				}
				discover_province = 1528
				discover_province = 1527
				# discover_province = 1522
				# discover_province = 1520
				# discover_province = 1519
				# discover_province = 1517
				# discover_province = 1515
				# discover_province = 491
				colombia_region = {
					limit = {
						has_port = yes
					}
					discover_country = ROOT
				}
			}
			else_if = {
				limit = {
					event_target:to_magellan_landing = {
						OR = {
							area = north_florida_area
							area = florida_area
							area = south_carolina_area
						}
					}
				}
				bahama_channel_area = {
					limit = {
						NOT = { province_id = 481 }
					}
					discover_country = ROOT
				}
				if = {
					limit = {
						event_target:to_magellan_landing = {
							OR = {
								area = south_carolina_area
								area = north_florida_area
							}
						}
					}
					discover_province = 1502
				}
				if = {
					limit = {
						event_target:to_magellan_landing = {
							OR = {
								area = florida_area
								area = north_florida_area
							}
						}
					}
					discover_province = 1506
				}
				every_province = {
					limit = {
						area = event_target:to_magellan_landing
						has_port = yes
					}
					discover_country = ROOT
				}
			}
			else = {
				every_province = {
					limit = {
						region = event_target:to_magellan_landing
						has_port = yes
					}
					discover_country = ROOT
				}
			}
		}
	}
}

to_accept_magellan_offer = {
	add_dip_power = -100
	custom_tooltip = to_begin_magellan_voyage_tt
	set_global_flag = to_magellan_has_departed
	set_country_flag = to_magellan_departure_country
	save_global_event_target_as = to_magellan_departure_country
	hidden_effect = {
		clear_global_event_target = to_magellan_initial_proposal
		every_country = {
			clr_country_flag = to_denied_magellan
		}
		random_country = {
			limit = {
				nhs_check_all_elysian_tags = { CONDITION = tag }
			}
			country_event = { id = to_colonialism_events.9 days = 90 }
		}
	}
}

to_reject_magellan_offer = {
	add_legitimacy = 10
	hidden_effect = {
		set_country_flag = to_denied_magellan
		set_global_flag = to_magellan_seaches_for_employment
	}
	to_find_new_magellan_target = yes
}

to_find_new_magellan_target = {
	if = {
		limit = {
			any_country = {
				ai = no
				OR = {
					tag = POR
					tag = CAS
					tag = SPA
				}
				any_owned_province = {
					continent = europe
					sea_zone = {
						region = north_atlantic_region
					}
				}
				capital_scope = {
					OR = {
						continent = europe
						superregion = africa_superregion
					}
				}
				NOT = { has_country_flag = to_denied_magellan }
			}
		}
		random_country = {
			limit = {
				ai = no
				OR = {
					tag = POR
					tag = CAS
					tag = SPA
				}
				any_owned_province = {
					continent = europe
					sea_zone = {
						region = north_atlantic_region
					}
				}
				capital_scope = {
					OR = {
						continent = europe
						superregion = africa_superregion
					}
				}
				NOT = { has_country_flag = to_denied_magellan }
			}
			country_event = { id = to_colonialism_events.7 days = 30 }
		}
	}
	else_if = {
		limit = {
			any_country = {
				ai = no
				religion_group = ROOT
				any_owned_province = {
					continent = europe
					sea_zone = {
						region = north_atlantic_region
					}
				}
				capital_scope = {
					OR = {
						continent = europe
						superregion = africa_superregion
					}
				}
				NOT = { has_country_flag = to_denied_magellan }
			}
		}
		random_country = {
			limit = {
				ai = no
				religion_group = ROOT
				any_owned_province = {
					continent = europe
					sea_zone = {
						region = north_atlantic_region
					}
				}
				capital_scope = {
					OR = {
						continent = europe
						superregion = africa_superregion
					}
				}
				NOT = { has_country_flag = to_denied_magellan }
			}
			country_event = { id = to_colonialism_events.7 days = 30 }
		}
	}
	else_if = {
		limit = {
			any_country = {
				OR = {
					tag = POR
					tag = CAS
					tag = SPA
				}
				any_owned_province = {
					continent = europe
					sea_zone = {
						region = north_atlantic_region
					}
				}
				capital_scope = {
					OR = {
						continent = europe
						superregion = africa_superregion
					}
				}
				NOT = { has_country_flag = to_denied_magellan }
			}
		}
		random_country = {
			limit = {
				OR = {
					tag = POR
					tag = CAS
					tag = SPA
				}
				any_owned_province = {
					continent = europe
					sea_zone = {
						region = north_atlantic_region
					}
				}
				capital_scope = {
					OR = {
						continent = europe
						superregion = africa_superregion
					}
				}
				NOT = { has_country_flag = to_denied_magellan }
			}
			country_event = { id = to_colonialism_events.7 days = 30 }
		}
	}
	else_if = {
		limit = {
			any_country = {
				religion_group = ROOT
				any_owned_province = {
					continent = europe
					sea_zone = {
						region = north_atlantic_region
					}
				}
				capital_scope = {
					OR = {
						continent = europe
						superregion = africa_superregion
					}
				}
				NOT = { has_country_flag = to_denied_magellan }
			}
		}
		random_country = {
			limit = {
				religion_group = ROOT
				any_owned_province = {
					continent = europe
					sea_zone = {
						region = north_atlantic_region
					}
				}
				capital_scope = {
					OR = {
						continent = europe
						superregion = africa_superregion
					}
				}
				NOT = { has_country_flag = to_denied_magellan }
			}
			country_event = { id = to_colonialism_events.7 days = 30 }
		}
	}
	else = {
		custom_tooltip = to_magellan_private_financing_tt
		clr_global_flag = to_magellan_seaches_for_employment
		set_global_flag = to_magellan_private_financing
		save_global_event_target_as = to_magellan_private_target
	}
}

to_clean_magellan_flags = {
	hidden_effect = {
		every_country = {
			clr_country_flag = to_magellan_departure_country
			clr_country_flag = to_denied_magellan
		}
		every_province = {
			clr_province_flag = to_magellan_landing
		}
		clr_global_flag = to_magellan_has_departed
		clr_global_flag = to_magellan_found_elysia
		clr_global_flag = to_magellan_seaches_for_employment
		clear_global_event_target = to_magellan_departure_country
		clear_global_event_target = to_magellan_initial_proposal
	}
}

to_development_events_add_next_flag = {
	# if = {
	# 	limit = {
	# 		has_province_flag = nhs_had_dev_events_2
	# 	}
	# 	set_province_flag = nhs_had_dev_events_3
	# }
	if = {
		limit = {
			has_province_flag = nhs_had_dev_events_1
		}
		set_province_flag = nhs_had_dev_events_2
	}
	else = {
		set_province_flag = nhs_had_dev_events_2
	}
}

to_add_2_stability_or_adm_power = {
	if = {
		limit = {
			stability = 3
		}
		add_adm_power = 100
	}
	else_if = {
		limit = {
			stability = 2
		}
		add_stability = 1
		add_adm_power = 50
	}
	else = {
		add_stability = 2
	}
}

to_round_up_variable = {
	change_variable = {
		which = $VARIABLE$
		value = 0.5
	}
	multiply_variable = { 
		which = $VARIABLE$
		value = 0.001
	}
	multiply_variable = { 
		which = $VARIABLE$
		value = 1000
	}
}

to_round_down_variable = {
	multiply_variable = { 
		which = $VARIABLE$
		value = 0.001
	}
	multiply_variable = { 
		which = $VARIABLE$
		value = 1000
	}
}

to_round_down_variable_one_decimal = {
	multiply_variable = { 
		which = $VARIABLE$
		value = 0.01
	}
	multiply_variable = { 
		which = $VARIABLE$
		value = 100
	}
}

to_remove_var_if_not_0 = {
	if = {
		limit = {
			NOT = {
				is_variable_equal = {
					which = $VARIABLE$
					value = 0
				}
			}
		}
		set_variable = {
			which = $VARIABLE$
			value = 0
		}
	}
}

to_save_historal_friends_and_rivals = {
	hidden_effect = {
		every_country = {
			limit = {
				historical_friend_with = ROOT
			}
			set_country_flag = to_historical_friend_with_ROOT
			remove_historical_friend = ROOT
		}
		every_country = {
			limit = {
				ROOT = {
					historical_friend_with = PREV
				}
			}
			set_country_flag = to_ROOT_historical_friend_with_TAG
			ROOT = {
				remove_historical_friend = PREV
			}
		}
		every_country = {
			limit = {
				historical_rival_with = ROOT
			}
			set_country_flag = to_historical_rival_with_ROOT
			remove_historical_rival = ROOT
		}
		every_country = {
			limit = {
				ROOT = {
					historical_rival_with = PREV
				}
			}
			set_country_flag = to_ROOT_historical_rival_with_TAG
			ROOT = {
				remove_historical_rival = PREV
			}
		}
	}
}

to_load_historal_friends_and_rivals = {
	hidden_effect = {
		every_country = {
			limit = {
				has_country_flag = to_historical_friend_with_ROOT
			}
			clr_country_flag = to_historical_friend_with_ROOT
			add_historical_friend = ROOT
		}
		every_country = {
			limit = {
				has_country_flag = to_ROOT_historical_friend_with_TAG
			}
			clr_country_flag = to_ROOT_historical_friend_with_TAG
			ROOT = {
				add_historical_friend = PREV
			}
		}
		every_country = {
			limit = {
				has_country_flag = to_historical_rival_with_ROOT
			}
			clr_country_flag = to_historical_rival_with_ROOT
			add_historical_rival = ROOT
		}
		every_country = {
			limit = {
				has_country_flag = to_ROOT_historical_rival_with_TAG
			}
			clr_country_flag = to_ROOT_historical_rival_with_TAG
			ROOT = {
				add_historical_rival = PREV
			}
		}
	}
}

to_restore_historal_friends_and_rivals = {
	hidden_effect = {
		every_country = {
			limit = {
				$PREVIOUS_TAG$ = {
					historical_friend_with = PREV
				}
			}
			$PREVIOUS_TAG$ = {
				remove_historical_friend = PREV
			}
			ROOT = {
				add_historical_friend = PREV
			}
		}
		every_country = {
			limit = {
				$PREVIOUS_TAG$ = {
					PREV = {
						historical_friend_with = PREV
					}
				}
			}
			$PREVIOUS_TAG$ = {
				PREV = {
					remove_historical_friend = PREV
				}
			}
			add_historical_friend = ROOT
		}
		every_country = {
			limit = {
				$PREVIOUS_TAG$ = {
					historical_rival_with = PREV
				}
			}
			$PREVIOUS_TAG$ = {
				remove_historical_rival = PREV
			}
			ROOT = {
				add_historical_rival = PREV
			}
		}
		every_country = {
			limit = {
				$PREVIOUS_TAG$ = {
					PREV = {
						historical_rival_with = PREV
					}
				}
			}
			$PREVIOUS_TAG$ = {
				PREV = {
					remove_historical_rival = PREV
				}
			}
			add_historical_rival = ROOT
		}
	}
}

to_monuments_later = {
	if = {
		limit = {
			$PROVINCE_ID$ = {
				construction_progress = 0
			}
		}
		if = {
			limit = {
				$PROVINCE_ID$ = {
					has_construction = colonist
				}
			}
			custom_tooltip = to_monuments_later_colonist_tt
		}
		else_if = {
			limit = {
				$PROVINCE_ID$ = {
					has_construction = missionary
				}
			}
			custom_tooltip = to_monuments_later_missionary_tt
		}
		else = {
			custom_tooltip = to_monuments_later_tt
		}
		custom_tooltip = nhs_new_line_tt
	}
}

to_correct_colony_culture = {
	if = {
		limit = {
			is_colonial_nation = yes
			NOT = { has_country_flag = to_colony_culture_corrected }
		}
		set_country_flag = to_colony_culture_corrected
		overlord = {
			if = {
				limit = {
					NOT = { nhs_post_fragmentation_culturally_elysian = yes }
				}
				PREV = {
					change_primary_culture = PREV
					set_ruler_culture = PREV
				}
			}
			else = {
				PREV = {
					to_ely_country_culture_check = { 
						FLAG_SCOPE = PREV
						FLAG_SCOPE_BACKUP = yes
					}
				}
			}
			PREV = {
				change_religion = PREV
			}
		}
	}
}

to_subject_monument_mod_transfer = {
	if = {
		limit = {
			owner = {
				is_subject = yes
			}
		}
		custom_tooltip = to_subject_monument_mod_transfer_subject_tt
	}
	else = {
		custom_tooltip = to_subject_monument_mod_transfer_tt
	}
}

to_handle_subject_annexation_date = {
	if = {
		limit = {
			NOT = { has_country_flag = to_do_not_change_annexation_date }
		}
		clr_country_flag = to_became_a_subject
		set_country_flag = to_became_a_subject
		export_to_variable = {
			which = to_protectorate_annexation_year_20
			value = trigger_value:is_year
		}
		set_variable = {
			which = to_protectorate_annexation_year_50
			which = to_protectorate_annexation_year_20
		}
		change_variable = {
			which = to_protectorate_annexation_year_20
			value = 20
		}
		change_variable = {
			which = to_protectorate_annexation_year_50
			value = 50
		}
		export_to_variable = {
			which = to_protectorate_annexation_month
			value = trigger_value:is_month
		}
		change_variable = {
			which = to_protectorate_annexation_month
			value = 2
		}
		if = {
			limit = {
				check_variable = {
					which = to_protectorate_annexation_month
					value = 13
				}
			}
			change_variable = {
				which = to_protectorate_annexation_year_20
				value = 1
			}
			change_variable = {
				which = to_protectorate_annexation_year_50
				value = 1
			}
			set_variable = {
				which = to_protectorate_annexation_month
				value = 1
			}
		}
	}
}

to_set_isolation_to_VALUE = {
	custom_tooltip = to_set_isolation_to_$VALUE$_tt
	hidden_effect = {
		set_isolationism = 0
	}
}


nhs_save_previous_goods = {
    clr_province_flag = nhs_had_grain_tg
    clr_province_flag = nhs_had_wine_tg
    clr_province_flag = nhs_had_wool_tg
    clr_province_flag = nhs_had_cloth_tg
    clr_province_flag = nhs_had_fish_tg
    clr_province_flag = nhs_had_fur_tg
    clr_province_flag = nhs_had_salt_tg
    clr_province_flag = nhs_had_naval_supplies_tg
    clr_province_flag = nhs_had_copper_tg
    clr_province_flag = nhs_had_gold_tg
    clr_province_flag = nhs_had_iron_tg
    clr_province_flag = nhs_had_slaves_tg
    clr_province_flag = nhs_had_ivory_tg
    clr_province_flag = nhs_had_tea_tg
    clr_province_flag = nhs_had_chinaware_tg
    clr_province_flag = nhs_had_spices_tg
    clr_province_flag = nhs_had_coffee_tg
    clr_province_flag = nhs_had_cotton_tg
    clr_province_flag = nhs_had_sugar_tg
    clr_province_flag = nhs_had_tobacco_tg
    clr_province_flag = nhs_had_cocoa_tg
    clr_province_flag = nhs_had_silk_tg
    clr_province_flag = nhs_had_elysian_silk_tg
    clr_province_flag = nhs_had_skoros_silk_tg
    clr_province_flag = nhs_had_tropical_wood_tg
    clr_province_flag = nhs_had_dyes_tg
    clr_province_flag = nhs_had_norse_mead_tg
    clr_province_flag = nhs_had_livestock_tg
    clr_province_flag = nhs_had_incense_tg
    clr_province_flag = nhs_had_glass_tg
    clr_province_flag = nhs_had_gems_tg
    clr_province_flag = nhs_had_paper_tg
    clr_province_flag = nhs_had_coal_tg
    clr_province_flag = nhs_had_cloves_tg
    clr_province_flag = nhs_had_unknown_tg
    clr_province_flag = nhs_had_coal_2_tg
    clr_province_flag = nhs_had_nothing_tg
	if = { limit = { trade_goods = grain } set_province_flag = nhs_had_grain_tg }
    else_if = { limit = { trade_goods = wine } set_province_flag = nhs_had_wine_tg }
    else_if = { limit = { trade_goods = wool } set_province_flag = nhs_had_wool_tg }
    else_if = { limit = { trade_goods = cloth } set_province_flag = nhs_had_cloth_tg }
    else_if = { limit = { trade_goods = fish } set_province_flag = nhs_had_fish_tg }
    else_if = { limit = { trade_goods = fur } set_province_flag = nhs_had_fur_tg }
    else_if = { limit = { trade_goods = salt } set_province_flag = nhs_had_salt_tg }
    else_if = { limit = { trade_goods = naval_supplies } set_province_flag = nhs_had_naval_supplies_tg }
    else_if = { limit = { trade_goods = copper } set_province_flag = nhs_had_copper_tg }
    else_if = { limit = { trade_goods = gold } set_province_flag = nhs_had_gold_tg }
    else_if = { limit = { trade_goods = iron } set_province_flag = nhs_had_iron_tg }
    else_if = { limit = { trade_goods = slaves } set_province_flag = nhs_had_slaves_tg }
    else_if = { limit = { trade_goods = ivory } set_province_flag = nhs_had_ivory_tg }
    else_if = { limit = { trade_goods = tea } set_province_flag = nhs_had_tea_tg }
    else_if = { limit = { trade_goods = chinaware } set_province_flag = nhs_had_chinaware_tg }
    else_if = { limit = { trade_goods = spices } set_province_flag = nhs_had_spices_tg }
    else_if = { limit = { trade_goods = coffee } set_province_flag = nhs_had_coffee_tg }
    else_if = { limit = { trade_goods = cotton } set_province_flag = nhs_had_cotton_tg }
    else_if = { limit = { trade_goods = sugar } set_province_flag = nhs_had_sugar_tg }
    else_if = { limit = { trade_goods = tobacco } set_province_flag = nhs_had_tobacco_tg }
    else_if = { limit = { trade_goods = cocoa } set_province_flag = nhs_had_cocoa_tg }
    else_if = { limit = { trade_goods = silk } set_province_flag = nhs_had_silk_tg }
    else_if = { limit = { trade_goods = elysian_silk } set_province_flag = nhs_had_elysian_silk_tg }
    else_if = { limit = { trade_goods = skoros_silk } set_province_flag = nhs_had_skoros_silk_tg }
    else_if = { limit = { trade_goods = tropical_wood } set_province_flag = nhs_had_tropical_wood_tg }
    else_if = { limit = { trade_goods = dyes } set_province_flag = nhs_had_dyes_tg }
    else_if = { limit = { trade_goods = norse_mead } set_province_flag = nhs_had_norse_mead_tg }
    else_if = { limit = { trade_goods = livestock } set_province_flag = nhs_had_livestock_tg }
    else_if = { limit = { trade_goods = incense } set_province_flag = nhs_had_incense_tg }
    else_if = { limit = { trade_goods = glass } set_province_flag = nhs_had_glass_tg }
    else_if = { limit = { trade_goods = gems } set_province_flag = nhs_had_gems_tg }
    else_if = { limit = { trade_goods = paper } set_province_flag = nhs_had_paper_tg }
    else_if = { limit = { trade_goods = coal } set_province_flag = nhs_had_coal_tg }
    else_if = { limit = { trade_goods = cloves } set_province_flag = nhs_had_cloves_tg }
    else_if = { limit = { trade_goods = unknown } set_province_flag = nhs_had_unknown_tg }
    else_if = { limit = { trade_goods = coal_2 } set_province_flag = nhs_had_coal_2_tg }
    else_if = { limit = { trade_goods = nothing } set_province_flag = nhs_had_nothing_tg }
}

nhs_load_previous_goods = {
	if = { limit = { has_province_flag = nhs_had_grain_tg } change_trade_goods = grain }
	else_if = { limit = { has_province_flag = nhs_had_wine_tg } change_trade_goods = wine }
	else_if = { limit = { has_province_flag = nhs_had_wool_tg } change_trade_goods = wool }
	else_if = { limit = { has_province_flag = nhs_had_cloth_tg } change_trade_goods = cloth }
	else_if = { limit = { has_province_flag = nhs_had_fish_tg } change_trade_goods = fish }
	else_if = { limit = { has_province_flag = nhs_had_fur_tg } change_trade_goods = fur }
	else_if = { limit = { has_province_flag = nhs_had_salt_tg } change_trade_goods = salt }
	else_if = { limit = { has_province_flag = nhs_had_naval_supplies_tg } change_trade_goods = naval_supplies }
	else_if = { limit = { has_province_flag = nhs_had_copper_tg } change_trade_goods = copper }
	else_if = { limit = { has_province_flag = nhs_had_gold_tg } change_trade_goods = gold }
	else_if = { limit = { has_province_flag = nhs_had_iron_tg } change_trade_goods = iron }
	else_if = { limit = { has_province_flag = nhs_had_slaves_tg } change_trade_goods = slaves }
	else_if = { limit = { has_province_flag = nhs_had_ivory_tg } change_trade_goods = ivory }
	else_if = { limit = { has_province_flag = nhs_had_tea_tg } change_trade_goods = tea }
	else_if = { limit = { has_province_flag = nhs_had_chinaware_tg } change_trade_goods = chinaware }
	else_if = { limit = { has_province_flag = nhs_had_spices_tg } change_trade_goods = spices }
	else_if = { limit = { has_province_flag = nhs_had_coffee_tg } change_trade_goods = coffee }
	else_if = { limit = { has_province_flag = nhs_had_cotton_tg } change_trade_goods = cotton }
	else_if = { limit = { has_province_flag = nhs_had_sugar_tg } change_trade_goods = sugar }
	else_if = { limit = { has_province_flag = nhs_had_tobacco_tg } change_trade_goods = tobacco }
	else_if = { limit = { has_province_flag = nhs_had_cocoa_tg } change_trade_goods = cocoa }
	else_if = { limit = { has_province_flag = nhs_had_silk_tg } change_trade_goods = silk }
	else_if = { limit = { has_province_flag = nhs_had_elysian_silk_tg } change_trade_goods = elysian_silk }
	else_if = { limit = { has_province_flag = nhs_had_skoros_silk_tg } change_trade_goods = skoros_silk }
	else_if = { limit = { has_province_flag = nhs_had_tropical_wood_tg } change_trade_goods = tropical_wood }
	else_if = { limit = { has_province_flag = nhs_had_dyes_tg } change_trade_goods = dyes }
	else_if = { limit = { has_province_flag = nhs_had_norse_mead_tg } change_trade_goods = norse_mead }
	else_if = { limit = { has_province_flag = nhs_had_livestock_tg } change_trade_goods = livestock }
	else_if = { limit = { has_province_flag = nhs_had_incense_tg } change_trade_goods = incense }
	else_if = { limit = { has_province_flag = nhs_had_glass_tg } change_trade_goods = glass }
	else_if = { limit = { has_province_flag = nhs_had_gems_tg } change_trade_goods = gems }
	else_if = { limit = { has_province_flag = nhs_had_paper_tg } change_trade_goods = paper }
	else_if = { limit = { has_province_flag = nhs_had_coal_tg } change_trade_goods = coal }
	else_if = { limit = { has_province_flag = nhs_had_cloves_tg } change_trade_goods = cloves }
	else_if = { limit = { has_province_flag = nhs_had_unknown_tg } change_trade_goods = unknown }
	else_if = { limit = { has_province_flag = nhs_had_coal_2_tg } change_trade_goods = coal_2 }
	else_if = { limit = { has_province_flag = nhs_had_nothing_tg } change_trade_goods = nothing }
	clr_province_flag = nhs_had_grain_tg
	clr_province_flag = nhs_had_wine_tg
	clr_province_flag = nhs_had_wool_tg
	clr_province_flag = nhs_had_cloth_tg
	clr_province_flag = nhs_had_fish_tg
	clr_province_flag = nhs_had_fur_tg
	clr_province_flag = nhs_had_salt_tg
	clr_province_flag = nhs_had_naval_supplies_tg
	clr_province_flag = nhs_had_copper_tg
	clr_province_flag = nhs_had_gold_tg
	clr_province_flag = nhs_had_iron_tg
	clr_province_flag = nhs_had_slaves_tg
	clr_province_flag = nhs_had_ivory_tg
	clr_province_flag = nhs_had_tea_tg
	clr_province_flag = nhs_had_chinaware_tg
	clr_province_flag = nhs_had_spices_tg
	clr_province_flag = nhs_had_coffee_tg
	clr_province_flag = nhs_had_cotton_tg
	clr_province_flag = nhs_had_sugar_tg
	clr_province_flag = nhs_had_tobacco_tg
	clr_province_flag = nhs_had_cocoa_tg
	clr_province_flag = nhs_had_silk_tg
	clr_province_flag = nhs_had_elysian_silk_tg
	clr_province_flag = nhs_had_skoros_silk_tg
	clr_province_flag = nhs_had_tropical_wood_tg
	clr_province_flag = nhs_had_dyes_tg
	clr_province_flag = nhs_had_norse_mead_tg
	clr_province_flag = nhs_had_livestock_tg
	clr_province_flag = nhs_had_incense_tg
	clr_province_flag = nhs_had_glass_tg
	clr_province_flag = nhs_had_gems_tg
	clr_province_flag = nhs_had_paper_tg
	clr_province_flag = nhs_had_coal_tg
	clr_province_flag = nhs_had_cloves_tg
	clr_province_flag = nhs_had_unknown_tg
	clr_province_flag = nhs_had_coal_2_tg
	clr_province_flag = nhs_had_nothing_tg
}

nhs_add_reform = {
	add_government_reform = $REF$
	# if = {
	# 	limit = {
	# 		has_dlc = "Dharma"
	# 	}
	# 	#[[REM]
	# 	#	remove_government_reform = $REM$
	# 	#]
	# 	add_government_reform = $REF$
	# }
}

nhs_add_gov_reform = {
	add_government_reform = $REF$
}

nhs_set_center_of_trade_1 = {
	custom_tooltip = nhs_add_center_of_trade_1_tt
	hidden_effect = {
		remove_province_modifier = to_dynamic_cot
		if = {
			limit = {
				NOT = { province_has_center_of_trade_of_level = 1 }
			}
			center_of_trade = 1
		}
		else = {
			owner = {
				add_treasury = 50
			}
		}
	}
}

nhs_set_center_of_trade_2 = {
	custom_tooltip = nhs_add_center_of_trade_2_tt
	hidden_effect = {
		remove_province_modifier = to_dynamic_cot
		if = {
			limit = {
				NOT = { province_has_center_of_trade_of_level = 1 }
			}
			center_of_trade = 2
		}
		else_if = {
			limit = {
				NOT = { province_has_center_of_trade_of_level = 2 }
			}
			add_center_of_trade_level = 1
		}
		else = {
			owner = {
				add_treasury = 100
			}
		}
	}
}

nhs_set_center_of_trade_3 = {
	custom_tooltip = nhs_add_center_of_trade_3_tt
	hidden_effect = {
		remove_province_modifier = to_dynamic_cot
		if = {
			limit = {
				NOT = { province_has_center_of_trade_of_level = 1 }
			}
			center_of_trade = 3
		}
		else_if = {
			limit = {
				NOT = { province_has_center_of_trade_of_level = 3 }
			}
			add_center_of_trade_level = 2
		}
		else = {
			owner = {
				add_treasury = 500
			}
		}
	}
}

nhs_set_center_in_a_region_to_level_3 = {
	if = {
		limit = {
			any_owned_province = {
				$CONDITION$
				province_has_center_of_trade_of_level = 2
				NOT = { province_has_center_of_trade_of_level = 3 }
			}
		}
		nhs_set_center_of_trade_3 = yes
	}
	else_if = {
		limit = {
			any_owned_province = {
				$CONDITION$
				province_has_center_of_trade_of_level = 1
				NOT = { province_has_center_of_trade_of_level = 3 }
			}
		}
		nhs_set_center_of_trade_3 = yes
	}
	else_if = {
		limit = {
			any_province = {
				$CONDITION$
				owns_or_non_sovereign_subject_of = ROOT
				province_has_center_of_trade_of_level = 2
				NOT = { province_has_center_of_trade_of_level = 3 }
			}
		}
		nhs_set_center_of_trade_3 = yes
	}
	else_if = {
		limit = {
			any_province = {
				$CONDITION$
				owns_or_non_sovereign_subject_of = ROOT
				province_has_center_of_trade_of_level = 1
				NOT = { province_has_center_of_trade_of_level = 3 }
			}
		}
		nhs_set_center_of_trade_3 = yes
	}
	else_if = {
		limit = {
			any_province = {
				$CONDITION$
				owns_or_subject_of = ROOT
				province_has_center_of_trade_of_level = 2
				NOT = { province_has_center_of_trade_of_level = 3 }
			}
		}
		nhs_set_center_of_trade_3 = yes
	}
	else_if = {
		limit = {
			any_province = {
				$CONDITION$
				owns_or_subject_of = ROOT
				province_has_center_of_trade_of_level = 1
				NOT = { province_has_center_of_trade_of_level = 3 }
			}
		}
		nhs_set_center_of_trade_3 = yes
	}
	else = {
		add_treasury = 750
	}
}

nhs_set_center_in_a_region = {
	if = {
		limit = {
			any_owned_province = {
				$TYPE$ = $CNRG$
				province_has_center_of_trade_of_level = 1
				NOT = { province_has_center_of_trade_of_level = 2 }
			}
		}
		random_owned_province = {
			limit = {
				$TYPE$ = $CNRG$
				province_has_center_of_trade_of_level = 1
				NOT = { province_has_center_of_trade_of_level = 2 }
			}
			nhs_set_center_of_trade_2 = yes
		}
	}
	else_if = {
		limit = {
			any_owned_province = {
				nhs_eicticofminh = yes
				$TYPE$ = $CNRG$
				NOT = { province_has_center_of_trade_of_level = 1 }
			}
		}
		random_owned_province = {
			limit = {
				nhs_eicticofminh = yes
				$TYPE$ = $CNRG$
				NOT = { province_has_center_of_trade_of_level = 1 }
			}
			nhs_set_center_of_trade_1 = yes
		}
	}
	else_if = {
		limit = {
			any_province = {
				owner = {
					is_subject_of = ROOT
				}
				nhs_eicticofminh = yes
				$TYPE$ = $CNRG$
				NOT = { province_has_center_of_trade_of_level = 1 }
			}
		}
		random_province = {
			limit = {
				owner = {
					is_subject_of = ROOT
				}
				nhs_eicticofminh = yes
				$TYPE$ = $CNRG$
				NOT = { province_has_center_of_trade_of_level = 1 }
			}
			nhs_set_center_of_trade_1 = yes
		}
	}
	else_if = {
		limit = {
			any_province = {
				owner = {
					is_subject_of = ROOT
				}
				nhs_eicticofminh = yes
				$TYPE$ = $CNRG$
				NOT = { province_has_center_of_trade_of_level = 1 }
			}
		}
		random_province = {
			limit = {
				owner = {
					is_subject_of = ROOT
				}
				nhs_eicticofminh = yes
				$TYPE$ = $CNRG$
				NOT = { province_has_center_of_trade_of_level = 1 }
			}
			nhs_set_center_of_trade_1 = yes
		}
	}
	else = {
		add_treasury = 75
	}
}

nhs_change_government = {
	change_government = $GOV$
	# if = {
	# 	limit = {
	# 		has_dlc = "Dharma"
	# 		NOT = { government = $GOV$ }
	# 	}
	# 	change_government = $GOV$
	# }
	# [[LEGACY]
	# 	set_legacy_government = $LEGACY$
	# ]
}

to_add_government_reform_short_tooltip = {
	custom_tooltip = to_add_$REFORM$_gov_reform_tt
	hidden_effect = {
		add_government_reform = $REFORM$
	}
}

to_non_abrahamic_conversion_penalty_check_province = {
	if = {
		limit = {
			to_has_abrahamic_religion = yes
			owner = {
				NOT = { to_has_abrahamic_religion = yes }
				NOT = { mission_completed = to_the_old_gods_mission }
				NOT = {
					AND = {
						is_subject = yes
						overlord = {
							OR = {
								mission_completed = to_the_old_gods_mission
								AND = {
									is_subject = yes
									overlord = {
										mission_completed = to_the_old_gods_mission
									}
								}
							}
						}
					}
				}
			}
		}
		add_province_modifier = {
			name = to_abrahamic_conversion_penalty
			duration = -1
		}
	}
	else_if = {
		limit = {
			has_province_modifier = to_abrahamic_conversion_penalty
		}
		remove_province_modifier = to_abrahamic_conversion_penalty
	}
}

to_non_abrahamic_conversion_penalty_check_country = {
	if = {
		limit = {
			OR = {
				to_has_abrahamic_religion = yes
				mission_completed = to_the_old_gods_mission
				AND = {
					is_subject = yes
					overlord = {
						OR = {
							mission_completed = to_the_old_gods_mission
							AND = {
								is_subject = yes
								overlord = {
									mission_completed = to_the_old_gods_mission
								}
							}
						}
					}
				}
			}
		}
		every_owned_province = {
			limit = {
				has_province_modifier = to_abrahamic_conversion_penalty
			}
			remove_province_modifier = to_abrahamic_conversion_penalty
		}
	}
	else = {
		every_owned_province = {
			limit = {
				to_has_abrahamic_religion = yes
			}
			add_province_modifier = {
				name = to_abrahamic_conversion_penalty
				duration = -1
			}
		}
	}
}

to_clear_RELIGION_defender_of_faith_et = {
	if = {
		limit = {
			has_global_flag = to_saved_$RELIGION$_dof_et
			NOT = {
				any_country = {
					is_defender_of_faith = yes
					religion = $RELIGION$
				}
			}
		}
		clr_global_flag = to_saved_$RELIGION$_dof_et
		clear_global_event_target = to_$RELIGION$_dof
	}
}

##################################################
# Missionary Strength from battles mechanic
##################################################

to_missionary_strength_from_battles_clear_flags = {
	clr_province_flag = to_missionary_strength_from_battles_cd
	# If you want this to work on other religions add more flags here
	clr_province_flag = to_missionary_strength_from_battles_aztlan
}

to_add_missionary_strength_from_battles = {
	if = {
		limit = {
			unit_owner = {
				has_government_attribute = to_missionary_strength_from_battles
			}
		}
		unit_owner = {
			save_event_target_as = to_battle_won_unit_tar
		}
		location = {
			area = {
				limit = {
					is_empty = no
					NOT = { religion = event_target:to_battle_won_unit_tar }
					owner = {
						OR = {
							tag = event_target:to_battle_won_unit_tar
							war_with = event_target:to_battle_won_unit_tar
						}
					}
					# If you want this to work on other religions expand this
					# OR = {
					# 	NOT = { to_has_missionary_strength_from_battles_TIER = { TIER = 4 } }
					# 	to_has_missionary_strength_from_battles_incorrect_religion = {
					# 		COUNTRY_SCOPE = event_target:to_battle_won_unit_tar 
					# 	}
					# }
					OR = {
						NOT = { has_province_flag = to_missionary_strength_from_battles_cd }
						had_province_flag = {
							flag = to_missionary_strength_from_battles_cd
							days = 1
						}
					}
				}
				# If you want this to work on other religions expand this
				# if = {
				# 	limit = {
				# 		to_has_missionary_strength_from_battles_incorrect_religion = { 
				# 			COUNTRY_SCOPE = event_target:to_battle_won_unit_tar 
				# 		}
				# 	}
				# 	to_missionary_strength_from_battles_clear_flags = yes
				# 	to_remove_missionary_strength_from_battles_TIER = { TIER = 1 }
				# 	to_remove_missionary_strength_from_battles_TIER = { TIER = 2 }
				# 	to_remove_missionary_strength_from_battles_TIER = { TIER = 3 }
				# 	to_remove_missionary_strength_from_battles_TIER = { TIER = 4 }
				# }

				clr_province_flag = to_missionary_strength_from_battles_cd
				set_province_flag = to_missionary_strength_from_battles_cd
				if = {
					limit = {
						owner = {
							tag = event_target:to_battle_won_unit_tar
						}
					}
					if = {
						limit = {
							to_has_missionary_strength_from_battles_TIER = { TIER = 3 }
						}
						to_remove_missionary_strength_from_battles_TIER = { TIER = 3 }
						add_province_modifier = {
							name = to_missionary_strength_from_battles_4
							duration = -1
						}
					}
					else_if = {
						limit = {
							to_has_missionary_strength_from_battles_TIER = { TIER = 2 }
						}
						to_remove_missionary_strength_from_battles_TIER = { TIER = 2 }
						add_province_modifier = {
							name = to_missionary_strength_from_battles_3
							duration = -1
						}
					}
					else_if = {
						limit = {
							to_has_missionary_strength_from_battles_TIER = { TIER = 1 }
						}
						to_remove_missionary_strength_from_battles_TIER = { TIER = 1 }
						add_province_modifier = {
							name = to_missionary_strength_from_battles_2
							duration = -1
						}
					}
					else = {
						add_province_modifier = {
							name = to_missionary_strength_from_battles_1
							duration = -1
						}
					}
				}
				else = {
					# If you want this to work on other religions expand this
					if = {
						limit = {
							event_target:to_battle_won_unit_tar = {
								religion = aztlan_worship
							}
						}
						set_province_flag = to_missionary_strength_from_battles_aztlan
					}
					if = {
						limit = {
							to_has_missionary_strength_from_battles_TIER = { TIER = 3 }
						}
						to_remove_missionary_strength_from_battles_TIER = { TIER = 3 }
						add_permanent_province_modifier = {
							name = to_missionary_strength_from_battles_inactive_4
							duration = -1
						}
					}
					else_if = {
						limit = {
							to_has_missionary_strength_from_battles_TIER = { TIER = 2 }
						}
						to_remove_missionary_strength_from_battles_TIER = { TIER = 2 }
						add_permanent_province_modifier = {
							name = to_missionary_strength_from_battles_inactive_3
							duration = -1
						}
					}
					else_if = {
						limit = {
							to_has_missionary_strength_from_battles_TIER = { TIER = 1 }
						}
						to_remove_missionary_strength_from_battles_TIER = { TIER = 1 }
						add_permanent_province_modifier = {
							name = to_missionary_strength_from_battles_inactive_2
							duration = -1
						}
					}
					else = {
						add_permanent_province_modifier = {
							name = to_missionary_strength_from_battles_inactive_1
							duration = -1
						}
					}
				}
			}
		}
	}
}

to_remove_missionary_strength_from_battles_TIER = {
	remove_province_modifier = to_missionary_strength_from_battles_$TIER$
	remove_province_modifier = to_missionary_strength_from_battles_inactive_$TIER$
}

to_activate_missionary_strength_from_battles = {
	if = {
		limit = {
			has_province_modifier = to_missionary_strength_from_battles_inactive_4
		}
		remove_province_modifier = to_missionary_strength_from_battles_inactive_4
		add_province_modifier = {
			name = to_missionary_strength_from_battles_4
			duration = -1
		}
	}
	else_if = {
		limit = {
			has_province_modifier = to_missionary_strength_from_battles_inactive_3
		}
		remove_province_modifier = to_missionary_strength_from_battles_inactive_3
		add_province_modifier = {
			name = to_missionary_strength_from_battles_3
			duration = -1
		}
	}
	else_if = {
		limit = {
			has_province_modifier = to_missionary_strength_from_battles_inactive_2
		}
		remove_province_modifier = to_missionary_strength_from_battles_inactive_2
		add_province_modifier = {
			name = to_missionary_strength_from_battles_2
			duration = -1
		}
	}
	else_if = {
		limit = {
			has_province_modifier = to_missionary_strength_from_battles_inactive_1
		}
		remove_province_modifier = to_missionary_strength_from_battles_inactive_1
		add_province_modifier = {
			name = to_missionary_strength_from_battles_1
			duration = -1
		}
	}
}

to_check_missionary_strength_from_battles = {
	if = {
		limit = {
			to_has_missionary_strength_from_battles_inactive = yes
		}
		owner = {
			save_event_target_as = to_battle_won_unit_tar
		}
		if = {
			limit = {
				owner = {
					has_government_attribute = to_missionary_strength_from_battles
					PREV = {
						to_has_missionary_strength_from_battles_correct_religion = { COUNTRY_SCOPE = PREV }
					}
				}
			}
			to_missionary_strength_from_battles_clear_flags = yes
			to_activate_missionary_strength_from_battles = yes
		}
		else = {
			to_missionary_strength_from_battles_clear_flags = yes
			to_remove_missionary_strength_from_battles_TIER = { TIER = 1 }
			to_remove_missionary_strength_from_battles_TIER = { TIER = 2 }
			to_remove_missionary_strength_from_battles_TIER = { TIER = 3 }
			to_remove_missionary_strength_from_battles_TIER = { TIER = 4 }
		}
	}
}

to_missionary_strength_from_battles_after_war = {
	if = {
		limit = {
			$CHECK_IF$
		}
		if = {
			limit = {
				is_at_war = no
			}
			clr_country_flag = to_missionary_strength_from_battles_is_at_war
		}
		[[CHECK_FROM] 
		FROM = {
			if = {
				limit = {
					is_at_war = no
				}
				clr_country_flag = to_missionary_strength_from_battles_is_at_war
			}
		}
		]
		every_province = {
			limit = {
				to_has_missionary_strength_from_battles_inactive = yes
			}
			if = {
				limit = {
					owned_by = PREV
					ROOT = {
						has_government_attribute = to_missionary_strength_from_battles
					}
					to_has_missionary_strength_from_battles_correct_religion = { COUNTRY_SCOPE = PREV }
				}
				to_activate_missionary_strength_from_battles = yes
			}
			else_if = {
				limit = {
					owner = {
						NOT = {
							AND = {
								has_government_attribute = to_missionary_strength_from_battles
								NOT = { religion = PREV }
								PREV = {
									to_has_missionary_strength_from_battles_correct_religion = { COUNTRY_SCOPE = PREV }
								}
							}
						}
						NOT = {
							AND = {
								is_at_war = yes
								any_war_enemy_country = {
									has_government_attribute = to_missionary_strength_from_battles
									NOT = { religion = PREV }
									PREV = {
										to_has_missionary_strength_from_battles_correct_religion = { COUNTRY_SCOPE = PREV }
									}
								}
							}
						}
					}
				}
				to_missionary_strength_from_battles_clear_flags = yes
				to_remove_missionary_strength_from_battles_TIER = { TIER = 1 }
				to_remove_missionary_strength_from_battles_TIER = { TIER = 2 }
				to_remove_missionary_strength_from_battles_TIER = { TIER = 3 }
				to_remove_missionary_strength_from_battles_TIER = { TIER = 4 }
			}
		}
	}
}

to_remove_missionary_strength_from_battles_from_owned_provinces = {
	every_owned_province = {
		limit = {
			to_has_missionary_strength_from_battles_active = yes
		}
		remove_province_modifier = to_missionary_strength_from_battles_1
		remove_province_modifier = to_missionary_strength_from_battles_2
		remove_province_modifier = to_missionary_strength_from_battles_3
		remove_province_modifier = to_missionary_strength_from_battles_4
	}
}

to_compute_merc_company_size = {
	export_to_variable = {
		which = to_total_development
		value = total_development
	}
	set_variable = {
		which = $OUTPUT_VARIABLE$
		which = to_total_development
	}
	multiply_variable = {
		which = $OUTPUT_VARIABLE$
		value = $REGIMENTS_PER_DEVELOPMENT$
	}
	to_round_down_variable = { VARIABLE = $OUTPUT_VARIABLE$ }
	if = {
		limit = {
			mil_tech = 16
		}
		set_variable = {
			which = to_merc_size_cap
			value = 30
		}
	}
	else_if = {
		limit = {
			mil_tech = 14
		}
		set_variable = {
			which = to_merc_size_cap
			value = 29
		}
	}
	else_if = {
		limit = {
			mil_tech = 11
		}
		set_variable = {
			which = to_merc_size_cap
			value = 27
		}
	}
	else_if = {
		limit = {
			mil_tech = 9
		}
		set_variable = {
			which = to_merc_size_cap
			value = 25
		}
	}
	else_if = {
		limit = {
			mil_tech = 6
		}
		set_variable = {
			which = to_merc_size_cap
			value = 24
		}
	}
	else_if = {
		limit = {
			mil_tech = 5
		}
		set_variable = {
			which = to_merc_size_cap
			value = 22
		}
	}
	else_if = {
		limit = {
			mil_tech = 2
		}
		set_variable = {
			which = to_merc_size_cap
			value = 20
		}
	}
	else = {
		set_variable = {
			which = to_merc_size_cap
			value = 15
		}
	}
	set_variable = {
		which = to_relative_size_mod
		value = $REGIMENTS_PER_DEVELOPMENT$
	}
	divide_variable = {
		which = to_relative_size_mod
		value = 0.05
	}
	multiply_variable = {
		which = to_merc_size_cap
		which = to_relative_size_mod
	}
	to_round_down_variable = { VARIABLE = to_merc_size_cap }
	if = {
		limit = {
			check_variable = {
				which = $OUTPUT_VARIABLE$
				which = to_merc_size_cap
			}
		}
		set_variable = {
			which = $OUTPUT_VARIABLE$
			which = to_merc_size_cap
		}
	}
	set_variable = {
		which = to_total_development
		which = 0
	}
	set_variable = {
		which = to_merc_size_cap
		which = 0
	}
	set_variable = {
		which = to_relative_size_mod
		which = 0
	}
}

to_change_manpower_by_VARIABLE = {
	set_variable = {
		which = to_manpower_change_counter
		which = $VARIABLE$
	}
	while = {
		limit = {
			check_variable = {
				which = to_manpower_change_counter
				value = 10000
			}
		}
		subtract_variable = {
			which = to_manpower_change_counter
			value = 10000
		}
		$SCOPE$ = {
			add_manpower = $SIGN$10
		}
	}
	while = {
		limit = {
			check_variable = {
				which = to_manpower_change_counter
				value = 1000
			}
		}
		subtract_variable = {
			which = to_manpower_change_counter
			value = 1000
		}
		$SCOPE$ = {
			add_manpower = $SIGN$1
		}
	}
	while = {
		limit = {
			check_variable = {
				which = to_manpower_change_counter
				value = 100
			}
		}
		subtract_variable = {
			which = to_manpower_change_counter
			value = 100
		}
		$SCOPE$ = {
			add_manpower = $SIGN$0.1
		}
	}
	while = {
		limit = {
			check_variable = {
				which = to_manpower_change_counter
				value = 10
			}
		}
		subtract_variable = {
			which = to_manpower_change_counter
			value = 10
		}
		$SCOPE$ = {
			add_manpower = $SIGN$0.01
		}
	}
	while = {
		limit = {
			check_variable = {
				which = to_manpower_change_counter
				value = 1
			}
		}
		subtract_variable = {
			which = to_manpower_change_counter
			value = 1
		}
		$SCOPE$ = {
			add_manpower = $SIGN$0.001
		}
	}
	set_variable = {
		which = to_manpower_change_counter
		which = 0
	}
}

to_check_culture_after_conversion = {
	if = {
		limit = {
			has_province_flag = to_check_culture_after_conversion
			
		}
		clr_province_flag = to_check_culture_after_conversion
		if = {
			limit = {
				owner = {
					nhs_post_fragmentation_culturally_elysian = yes
				}
			}
			if = {
				limit = {
					culture = greek
					continent = north_america
				}
				change_culture = romaic
				to_ely_province_culture_check = {}
				hidden_effect = {
					nhs_on_province_culture_converted_general = {}
				}
			}
			else = {
				to_ely_province_culture_check = {}
				hidden_effect = {
					nhs_on_province_culture_converted_general = {}
				}
			}
		}
		else_if = {
			limit = {
				owner = {
					culture_group = norse_g
				}
			}
			to_nhs_assign_correct_vinlandic_culture = {}
		}
	}
}

to_set_country_ruler_heir_consort_culture = {
	change_primary_culture = $CULTURE$
	set_ruler_culture = $CULTURE$
	if = {
		limit = {
			has_heir = yes
		}
		set_heir_culture = $CULTURE$
	}
	if = {
		limit = {
			has_consort = yes
		}
		set_consort_culture = $CULTURE$
	}
}

to_set_ruler_heir_consort_culture_if_primary = {
	if = {
		limit = {
			ruler_culture = $PRIMARY_CULTURE$
		}
		set_ruler_culture = $CULTURE$
	}
	if = {
		limit = {
			has_heir = yes
			heir_culture = $PRIMARY_CULTURE$
		}
		set_heir_culture = $CULTURE$
	}
	if = {
		limit = {
			has_consort = yes
			consort_culture = $PRIMARY_CULTURE$
		}
		set_consort_culture = $CULTURE$
	}
}

to_primary_culture_and_ruler_heir_consort_culture_if_primary = {
	tooltip = {
		change_primary_culture = $CULTURE$
	}
	[[ONLY_SHOW_PRIMARY]
	hidden_effect = {
	]
		to_set_ruler_heir_consort_culture_if_primary = {
			CULTURE = $CULTURE$
			PRIMARY_CULTURE = $PRIMARY_CULTURE$
		}
	[[ONLY_SHOW_PRIMARY]
	}
	]
	hidden_effect = {
		change_primary_culture = $CULTURE$
	}
}

to_remove_fraction_of_aggressive_expansion = {
	hidden_effect = {
		every_country = {
			limit = {
				NOT = { tag = ROOT }
				$COUNTRY_TRIGGER$
			}
			while = {
				limit = {
					has_opinion_modifier = {
						who = ROOT
						modifier = aggressive_expansion
					}
				}
				change_variable = {
					which = to_ae_counter
					value = 1
				}
				add_aggressive_expansion = {
					who = ROOT
					value = -1
					apply_calc = no
				}
			}
			multiply_variable = {
				which = to_ae_counter
				value = $FRACTION$
			}
			while = {
				limit = {
					check_variable = {
						which = to_ae_counter
						value = 1
					}
				}
				change_variable = {
					which = to_ae_counter
					value = -1
				}
				add_aggressive_expansion = {
					who = ROOT
					value = 1
					apply_calc = no
				}
			}
			set_variable = {
				which = to_ae_counter
				value = 0
			}
		}
	}
}

to_destroy_forbidden_colonies = {
	if = {
		limit = {
			OR = {
				AND = {
					OR = {
						colonial_region = colonial_eastern_america
						province_id = 953
					}
					owner = {
						to_has_or_overlord_has_claim_colonial_region_peace_treaty = {
							COLONIAL_REGION = colonial_eastern_america
						}
					}
				}
				AND = {
					colonial_region = colonial_louisiana
					owner = {
						to_has_or_overlord_has_claim_colonial_region_peace_treaty = {
							COLONIAL_REGION = colonial_louisiana
						}
					}
				}
				AND = {
					colonial_region = colonial_california
					owner = {
						to_has_or_overlord_has_claim_colonial_region_peace_treaty = {
							COLONIAL_REGION = colonial_california
						}
					}
				}
				AND = {
					colonial_region = colonial_mexico
					owner = {
						to_has_or_overlord_has_claim_colonial_region_peace_treaty = {
							COLONIAL_REGION = colonial_mexico
						}
					}
				}
				AND = {
					colonial_region = colonial_the_carribean
					owner = {
						to_has_or_overlord_has_claim_colonial_region_peace_treaty = {
							COLONIAL_REGION = colonial_the_carribean
						}
					}
				}
				AND = {
					OR = {
						colonial_region = colonial_canada
						province_id = 980
						province_id = 997
						province_id = 994
					}
					owner = {
						to_has_or_overlord_has_claim_colonial_region_peace_treaty = {
							COLONIAL_REGION = colonial_canada
						}
					}
				}
				AND = {
					colonial_region = colonial_alaska
					owner = {
						to_has_or_overlord_has_claim_colonial_region_peace_treaty = {
							COLONIAL_REGION = colonial_alaska
						}
					}
				}
				AND = {
					colonial_region = colonial_colombia
					owner = {
						to_has_or_overlord_has_claim_colonial_region_peace_treaty = {
							COLONIAL_REGION = colonial_colombia
						}
					}
				}
				AND = {
					colonial_region = colonial_peru
					owner = {
						to_has_or_overlord_has_claim_colonial_region_peace_treaty = {
							COLONIAL_REGION = colonial_peru
						}
					}
				}
				AND = {
					colonial_region = colonial_la_plata
					owner = {
						to_has_or_overlord_has_claim_colonial_region_peace_treaty = {
							COLONIAL_REGION = colonial_la_plata
						}
					}
				}
				AND = {
					colonial_region = colonial_brazil
					owner = {
						to_has_or_overlord_has_claim_colonial_region_peace_treaty = {
							COLONIAL_REGION = colonial_brazil
						}
					}
				}
				AND = {
					colonial_region = colonial_australia
					owner = {
						to_has_or_overlord_has_claim_colonial_region_peace_treaty = {
							COLONIAL_REGION = colonial_australia
						}
					}
				}
				AND = {
					has_global_flag = nhs_treaty_of_lantanopolis
					OR = {
						AND = {
							continent = north_america
							owner = {
								OR = {
									has_country_modifier = nhs2_treaty_of_lantanopolis_por
									AND = {
										is_subject = yes
										NOT = { nhs_check_all_elysian_tags = { CONDITION = tag } }
										overlord = {
											OR = {
												has_country_modifier = nhs2_treaty_of_lantanopolis_por
												AND = {
													is_subject = yes
													NOT = { nhs_check_all_elysian_tags = { CONDITION = tag } }
													overlord = {
														has_country_modifier = nhs2_treaty_of_lantanopolis_por
													}
												}
											}
										}
									}
								}
							}
						}
						AND = {
							continent = south_america
							owner = {
								OR = {
									nhs_check_all_elysian_tags = { CONDITION = tag }
									AND = {
										is_subject = yes
										NOT = { has_country_modifier = nhs2_treaty_of_lantanopolis_por }
										overlord = {
											OR = {
												nhs_check_all_elysian_tags = { CONDITION = tag }
												AND = {
													is_subject = yes
													NOT = { has_country_modifier = nhs2_treaty_of_lantanopolis_por }
													overlord = {
														nhs_check_all_elysian_tags = { CONDITION = tag }
													}
												}
											}
										}
									}
								}
							}
						}
					}
				}
			}
		}
		add_province_modifier = {
			name = nhs2_treaty_of_lantanopolis_colonial_growth_reduction
			duration = -1
		}
	}
}